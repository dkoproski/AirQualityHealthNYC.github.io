---
title: "Data Processing"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: show
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
library(tidyverse)
library(plotly)
library(janitor)
library(readr)
options(readr.show_col_types = FALSE)
```

# Disease dataset

### *Merging hospitalization/emergency department data involving asthma counts, respiratory diseases and pneumonia*

```{r, message = FALSE}
# Load dataset with respiratory and asthma counts (missing some zipcodes)

dis_asth_df = read_csv(here::here("data/cleaned_data/joined_respiratory.csv"),
                       col_types = cols(
                          `date` = col_date(format = '%m/%d/%y'))) |> 
  rename(zip_code = zip) |> 
  filter(zip_code != 88888 & zip_code != "Citwide" & age_group == "All age groups") |> 
  mutate(year = as.numeric(format(date, format = "%Y")),
         month = month.name[as.numeric(format(date, format = "%m"))],
         day = as.numeric(format(date, format = "%d")),
         zip_code = as.numeric(zip_code)) |>
  select(year, month, day, zip_code, count_resp, count_asth) 

# Load dataset with pneumonia data

dis_pneu_df = read_csv(here::here("data/raw_data/disease_hospital_admin.csv"),
                       col_types = cols(
                                     `date` = col_date(format = "%m/%d/%Y"),
                                     `total_ed_visits` = col_integer(),
                                     `ili_pne_visits` = col_integer(),
                                     `ili_pne_admissions` = col_integer())) |> 
  separate(date, into=c("year", "month", "day")) |> 
  mutate(day = as.numeric(day),
         month = month.name[as.numeric(month)],
         year = as.numeric(year)) |> 
  rename(zip_code = mod_zcta) |> 
  select(year, month, day, zip_code, total_ed_visits, ili_pne_visits, ili_pne_admissions)

# Merge two disease datasets

all_dis_df =
  full_join(dis_asth_df, dis_pneu_df, by = c("zip_code", "year", 'month', 'day'))
```

### *Merging hospitalization/emergency department data with zip code data containing neighborhood and borough information*

```{r, message = FALSE}
#loading zip code data
zip_shapes <- read_csv(here::here('data/cleaned_shapes/nyc_zip_codes.csv')) %>%
  clean_names()

# merging disease with zip code data to add neigh & borough data

all_dis_df <- left_join(all_dis_df, zip_shapes, by = 'zip_code') %>%
  mutate(
    #these zip codes needed manual inputs
    #bc not in zip_shapes file
    neighborhood = case_when(
      zip_code == '10069' ~ 'Upper West Side',
      zip_code == '11109' ~ 'Northwest Queens',
      zip_code == '10282' ~ 'Lower Manhattan',
      zip_code == '10271' ~ 'Lower Manhattan',
      zip_code == '10278' ~ 'Lower Manhattan',
      zip_code == '10279' ~ 'Lower Manhattan',
      #zip_code == '11003' ~ 10000 (deal w these)
      #zip_code == '11040'
      TRUE ~ neighborhood),
    
    borough = case_when(
      zip_code == '10069' ~ 'Manhattan',
      zip_code == '11109' ~ 'Queens',
      zip_code == '10282' ~ 'Manhattan',
      zip_code == '10271' ~ 'Manhattan',
      zip_code == '10278' ~ 'Manhattan',
      zip_code == '10279' ~ 'Manhattan',
      TRUE ~ borough)) %>%
  
  #removing these zip codes bc
  #not apart of the 5 boroughs
  filter(!(zip_code == '10000'),
         !(zip_code == '11003'),
         !(zip_code == '11040'))
```


# Disease EDA dataset

```{r, message = FALSE}
disease_eda <- all_dis_df %>%
  pivot_longer(cols = 'count_resp':'ili_pne_admissions',
               names_to = 'illness_counts',
               values_to = 'count') %>%
  mutate(month_num = match(month, month.name),
         date = as.Date(paste(year, month_num, day, sep = '-'),
                        format = '%Y-%m-%d'),
         
         illness_counts = case_when(
           illness_counts == 'total_ed_visits' ~ 'ED visits (overall)',
           illness_counts == 'ili_pne_visits' ~ 'Pneumonia (ER visits)',
           illness_counts == 'ili_pne_admissions' ~ 'Pneumonia (ER admissions)',
           illness_counts == 'count_resp' ~ 'Respiratory diseases',
           illness_counts == 'count_asth' ~ 'Asthma'))
```


# Observing specific neighborhoods

### *Creating neighborhood-level dataset for disease counts*

```{r, message = FALSE}
#loading neighborhood sites data
sites_neighb <- read_csv(here::here("data/cleaned_data/pollutant_per_neighborhood.csv"))

#neighborhoods of interest
neighborhoods = c("Washington Heights", "Union Square - Lower East Side",
                  "Willowbrook", "Hunts Point - Mott Haven", "Fresh Meadows")

store_data = vector("list", length = 5)

for (i in 1:length(neighborhoods)) {
  
  n = neighborhoods[i]
  
  n_zips = sites_neighb %>%
  filter(geo_place_name == n) %>%
  pull(zip_code)
  
  counts_data = disease_eda %>%
    filter(zip_code %in% n_zips) %>%
    group_by(date, illness_counts) %>%
    summarize(total_counts = sum(count)) %>%
    mutate(neighborhood = n)
  
  store_data[[i]] = counts_data}

#combining data above
daily_disease_neigh <- bind_rows(store_data[[1]], store_data[[2]]) %>%
  bind_rows(store_data[[3]]) %>%
  bind_rows(store_data[[4]]) %>%
  bind_rows(store_data[[5]]) %>%
  mutate(date = as.Date(date, format = '%Y-%m-%d'))
```


# Air quality data

```{r, message = FALSE}

```




# Merging air quality data with disease data

```{r, message = FALSE}
#altering format
daily_disease_neigh = daily_disease_neigh %>%
  pivot_wider(names_from = illness_counts, values_from = total_counts)

#loading fixed air quality data
air_neighb <- read_csv(here::here('data/cleaned_data/air_neighborhood.csv'))

#altering format
air_neighb = air_neighb %>%
  pivot_wider(names_from = pollutant, values_from = mean_value)

#merging air & disease
disease_air <- full_join(daily_disease_neigh, air_neighb, by = c('date', "neighborhood")) %>%
  filter(date >= '2020-03-01' & date < '2022-12-01') %>%
  mutate(year = as.factor(format(date, format = '%Y')),
         month = month.name[as.numeric(format(date, format = "%m"))],
         day = as.numeric(format(date, format = "%d")),
         #adding seasons
         season = case_when(
           month %in% c('June', 'July', 'August') ~ 'Summer',
           month %in% c('September', 'October', 'November') ~ 'Fall',
           month %in% c('December', 'January', 'February') ~ 'Winter',
           month %in% c('March', 'April', 'May') ~ 'Spring'))

```




Old code below:..

# Air quality dataset

```{r, eval = F}
air_qual_df = read_csv("data/cleaned_data/alt_air_data.csv") |> 
  separate(date, into=c("month", "day", "year")) |>
  mutate(day = as.numeric(day),
         month = month.name[as.numeric(month)],
         year = as.numeric(year)) |> 
  filter(!(year == '2020' & month == 'January'),
         !(year == '2020' & month == 'February')) |> 
  select(year, month, day, zip_code, pollutant, value) |> 
  group_by(day, month, year, zip_code, pollutant) |> 
  summarize(value = mean(value))
```

# Merging air quality data with disease data

``` {r, eval = F}
# Finally merge disease and air_qual data together

air_qual_dis = 
  full_join(all_dis_df, air_qual_df, by = c("month", "day", "year", "zip_code")) |>  
  mutate(
    numeric_month = match(month, month.name),
    date = as.Date(paste(year, numeric_month, day, sep = "-"), format = "%Y-%m-%d")
  ) |> 
  select(year, month, day, date, zip_code, count_resp, count_asth, total_ed_visits, 
         ili_pne_visits, ili_pne_admissions, pollutant, value) |> 
  pivot_wider(names_from = pollutant,
              values_from = value) |> 
  select(-`NA`) |> 
  rename(pm25_ug_m3_lc = PM2.5,
         co_ppm = CO,
         o3_ppm = Ozone,
         no2_ppb = NO2) |> 
  filter(!(year == '2022' & month == 'December')) 
```


# !!! do we still need this chunk below? it was to compare two air quality datasets (daily vs. seasonal/annual)

```{r, eval = F}
airqual_annual = read_csv("data/cleaned_data/uhf_airquality.csv") |> 
  filter(str_detect(name, "Fine") | str_detect(name, "NO2") | str_detect(name, "O3")) 

#### Prepare dataset from daily data (Summer: 1June-31Aug, Winter 1Dec-28Feb)

# Annual averages for each pollutant and each zip

airqual_yr_avg = air_qual_df |> 
  group_by(year, zip, pollutant) |> 
  summarize(mean = mean(value)) |> 
  pivot_wider(
    names_from = pollutant,
    values_from = mean
  )

# Seasonal averages for each pollutant and each zip

airqual_szn_avg = air_qual_df |> 
  mutate(season = case_when(
    month %in% c("June", "July", "August") ~ "summer",
    month %in% c("December", "January", "February") ~ "winter",
    TRUE ~ "other"
  )) |> 
  filter(season != "other") |> 
  group_by(season, year, zip, pollutant) |> 
  summarize(mean = mean(value)) |> 
  pivot_wider(
    names_from = pollutant,
    values_from = mean
  )

#### Prepare dataset from daily data

airqual_annual = read_csv("data/cleaned_data/uhf_airquality.csv") |> 
  filter(str_detect(name, "Fine") | str_detect(name, "NO2") | str_detect(name, "O3")) |> 
  select(name, )

#### Comparison between daily data and yearly/seasonal data

```









