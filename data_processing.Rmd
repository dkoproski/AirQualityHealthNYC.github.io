---
title: "Data Processing"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: show
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
library(tidyverse)
library(plotly)
options(readr.show_col_types = FALSE)
```

# Disease dataset

### *Merging hospitalization/emergency department data involving asthma counts, respiratory diseases and pneumonia*

```{r, message = FALSE}
# Load dataset with respiratory and asthma counts (missing some zipcodes)

dis_asth_df = read_csv(here::here("data/cleaned_data/joined_respiratory.csv"),
                       col_types = cols(
                          `date` = col_date(format = '%m/%d/%y'))) |> 
  filter(zip != 88888 & zip != "Citwide" & age_group == "All age groups") |> 
  mutate(year = as.numeric(format(date, format = "%Y")),
         month = month.name[as.numeric(format(date, format = "%m"))],
         day = as.numeric(format(date, format = "%d")),
         zip = as.numeric(zip)) |>
  rename(zip_code = zip) |>
  select(year, month, day, zip_code, count_resp, count_asth) 

# Load dataset with pneumonia data

dis_pneu_df = read_csv(here::here("data/raw_data/disease_hospital_admin.csv"),
                       col_types = cols(
                                     `date` = col_date(format = "%m/%d/%Y"),
                                     `total_ed_visits` = col_integer(),
                                     `ili_pne_visits` = col_integer(),
                                     `ili_pne_admissions` = col_integer())) |> 
  separate(date, into=c("year", "month", "day")) |> 
  mutate(day = as.numeric(day),
         month = month.name[as.numeric(month)],
         year = as.numeric(year)) |> 
  rename(zip_code = mod_zcta) |> 
  select(year, month, day, zip_code, total_ed_visits, ili_pne_visits, ili_pne_admissions)

# Merge two disease datasets

all_dis_df =
  full_join(dis_asth_df, dis_pneu_df, by = c("zip_code", "year", 'month', 'day'))
```

# Air quality dataset

```{r}
air_qual_df = read_csv("data/cleaned_data/alt_air_data.csv") |> 
  separate(date, into=c("month", "day", "year")) |>
  mutate(day = as.numeric(day),
         month = month.name[as.numeric(month)],
         year = as.numeric(year)) |> 
  filter(!(year == '2020' & month == 'January'),
         !(year == '2020' & month == 'February')) |> 
  rename(zip = zip_code) |> 
  select(year, month, day, zip, pollutant, value) |> 
  group_by(day, month, year, zip, pollutant) |> 
  summarize(value = mean(value))
```

# Merging air quality data with disease data

``` {r}
# Finally merge disease and air_qual data together

air_qual_dis = 
  full_join(all_dis_df, air_qual_df, by = c("month", "day", "year", "zip")) |>  
  mutate(
    numeric_month = match(month, month.name),
    date = as.Date(paste(year, numeric_month, day, sep = "-"), format = "%Y-%m-%d")
  ) |> 
  select(year, month, day, date, zip, count_resp, count_asth, total_ed_visits, 
         ili_pne_visits, ili_pne_admissions, pollutant, value) |> 
  pivot_wider(names_from = pollutant,
              values_from = value) |> 
  select(-`NA`) |> 
  rename(pm25_ug_m3_lc = PM2.5,
         co_ppm = CO,
         o3_ppm = Ozone,
         no2_ppb = NO2) |> 
  filter(!(year == '2022' & month == 'December')) 
```


# !!! do we still need this chunk below? it was to compare two air quality datasets (daily vs. seasonal/annual)

```{r, eval = F}
airqual_annual = read_csv("data/cleaned_data/uhf_airquality.csv") |> 
  filter(str_detect(name, "Fine") | str_detect(name, "NO2") | str_detect(name, "O3")) 

#### Prepare dataset from daily data (Summer: 1June-31Aug, Winter 1Dec-28Feb)

# Annual averages for each pollutant and each zip

airqual_yr_avg = air_qual_df |> 
  group_by(year, zip, pollutant) |> 
  summarize(mean = mean(value)) |> 
  pivot_wider(
    names_from = pollutant,
    values_from = mean
  )

# Seasonal averages for each pollutant and each zip

airqual_szn_avg = air_qual_df |> 
  mutate(season = case_when(
    month %in% c("June", "July", "August") ~ "summer",
    month %in% c("December", "January", "February") ~ "winter",
    TRUE ~ "other"
  )) |> 
  filter(season != "other") |> 
  group_by(season, year, zip, pollutant) |> 
  summarize(mean = mean(value)) |> 
  pivot_wider(
    names_from = pollutant,
    values_from = mean
  )

#### Prepare dataset from daily data

airqual_annual = read_csv("data/cleaned_data/uhf_airquality.csv") |> 
  filter(str_detect(name, "Fine") | str_detect(name, "NO2") | str_detect(name, "O3")) |> 
  select(name, )

#### Comparison between daily data and yearly/seasonal data

```









