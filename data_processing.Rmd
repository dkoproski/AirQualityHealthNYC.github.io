---
title: "Data Processing"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: cosmo
    code_folding: show
---
```{r, message = FALSE}
library(tidyverse)
```

# Hospitalization data by zip code for asthma and respiratory diseases


```{r, eval = FALSE}
nyc_zips =
  read_csv("data/cleaned_shapes/nyc_zip_codes.csv") |> 
  mutate(zip = as.character(ZipCode)) |> 
  select(zip)

resp_df = 
  read_csv("data/raw_data/respiratory.csv")

asth_df = 
  read_csv("data/raw_data/asthma.csv")

resp_df_tidy =
  resp_df |> 
  janitor::clean_names() |> 
  mutate(age_group = dim2value,
         count_resp = count) |> 
  select(zip, age_group, date, count_resp) 

asth_df_tidy = 
  asth_df |> 
  janitor::clean_names() |> 
  mutate(age_group = dim2value,
         count_asth = count) |> 
  select(zip, age_group, date, count_asth) 

df_all_resp = 
  merge(resp_df_tidy, asth_df_tidy, by = c("zip", "date", "age_group"))
  
df_all_resp |> 
  write_csv("data/joined_respiratory.csv")
```


```{r}
df_all_resp =
  read_csv("data/cleaned_data/joined_respiratory.csv")
### note, the above dataset contains info on age groups, I have to filter this out to merge the data. If you want to use age groups in any analyses, use "df_all_resp".

df_hosp =
  read_csv("data/cleaned_data/disease_zip.csv") |> 
  mutate(zip = as.character(zip_code))

df_all_resp_merge =
  df_all_resp |> 
  filter(age_group == "All age groups") |> 
  select(zip, date, count_resp, count_asth) |>
  mutate(date = mdy(date)) |> 
  mutate(
    month = format(date, "%B"),  
    day = as.character(day(date)),             
    year = year(date)            
  ) |> 
  filter(zip != 88888) |> 
  filter(zip != "Citwide")


df_all_hospitalizations =
  left_join(df_all_resp_merge, df_hosp, by = c("month", "day", "year", "zip"))

df_all_hospitalizations2 =
  left_join(df_hosp, df_all_resp_merge, by = c("month", "day", "year", "zip"))

df_all_hospitalizations_inner =
  inner_join(df_hosp, df_all_resp_merge, by = c("month", "day", "year", "zip"))
```

```{r, eval = F}
unique_dates = unique(df_all_resp$date)
unique_zips = unique(df_all_resp$zip)

full_combinations = expand.grid(date = unique_dates, zip = unique_zips)

missing_combinations_asthma_resp = anti_join(full_combinations, df_all_resp, by = c("date", "zip"))

missing_combinations_asthma_resp










full_combinations = expand.grid(date = unique_dates, zip = unique_zips)

missing_combinations_hosp = anti_join(full_combinations, df_hosp, by = c("date", "zip"))

missing_combinations_hosp
```

# Merging `joined_respiratory.csv` and `air_quality_disease.csv`


```{r}
library(tidyverse)

# Load dataset with respiratory and asthma counts
dis_df = read_csv("data/cleaned_data/joined_respiratory.csv") |> 
  filter(zip != 88888 & zip != "Citwide" & age_group == "All age groups") |> 
  mutate(date = as.Date(format(as.Date(date, "%m/%d/%y"))),
         year = as.numeric(format(date, format = "%Y")),
         month = month.name[as.numeric(format(date, format = "%m"))],
         day = as.numeric(format(date, format = "%d")),
         zip = as.numeric(zip)) |>
  select(-date, -age_group)

# Load cleaned air quality dataset that has been merged with disease
air_dis_df = read_csv("data/cleaned_data/air_quality_disease.csv") |> 
  rename(zip = zip_code) |> 
  mutate(day = as.numeric(day)) |> 
  select(year, month, day, zip, total_ed_visits, ili_pne_visits, ili_pne_admissions, everything())

# Merge two datasets
all_dis_df =
  full_join(dis_df, air_dis_df, by = c("month", "day", "year", "zip")) |> 
  select(year, month, day, zip, total_ed_visits, ili_pne_visits, ili_pne_admissions, count_resp, count_asth, everything())

# Realized many NAs, suspect zipcode and date NAs
checkdate_perzip_airdis = air_dis_df |> 
  group_by(zip) |> 
  summarize(count = n())

checkdate_perzip_dis = dis_df |> 
  group_by(zip) |> 
  summarize(count = n())

# Found many NAs in air_quality_disease.csv - need revision
```

