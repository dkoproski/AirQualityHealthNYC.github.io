---
title: "Air Quality and Health in NYC"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---
```{r, echo = FALSE, message = FALSE, warning = FALSE}
library(tidyverse)
library(leaflet)
library(plotly)
library(glue)
library(leaflet.extras)
library(janitor)
library(statar)
library(modelr)
options(readr.show_col_types = FALSE)
```

*by Lupe Antonio Lopez, Gustavo Garcia-Franceschini, Dylan Koproski, Ru Jin Lim, Ixtaccihuatl Obregon.*

# Project Report 
 
## **Introduction** 

### Motivation and background

Public health and overall community well-being are impacted by environmental factors such as the concentration of air pollutants in an area. While recent policy and public sentiment has lowered the emissions of air pollutants in many urban environments, air pollution still poses a threat to millions annually. This is especially true in urban environments with large amounts of industry and vehicle emissions. New York City is a great example of an urban setting where air pollution has been [decreasing](https://www.nyc.gov/site/doh/about/press/pr2022/earth-day-new-report-on-nyc-air-quality.page#:~:text=NYC%20Community%20Air%20Survey%20Findings%20Between%202009%20and%202020,ozone%20levels%20have%20remained%20stable.) over the past decade, but some regions still remain vulnerable. Thus, more research is required to determine where future initiatives should be targeted to best improve New York City air quality. This project aims to review the geographic and temporal distribution of air pollutants to determine if recent air pollution trends contribute to respiratory related hospitalizations and to determine which regions are experiencing the worst air pollution.

While there are countless air pollutants, key pollutants of public health concern include: carbon monoxide (CO), ozone (O3), nitrogen dioxide (NO2), and  fine particulate matter 2.5 (PM2.5) [(WHO)](https://www.who.int/health-topics/air-pollution#tab=tab_1). As a colorless and odorless gas, CO poses a great health risk when inhaled in large amounts. Majority of CO levels are attributed to machinery that use fossil fuels such as vehicles and gas space heaters [(EPA)](https://www.epa.gov/co-pollution/basic-information-about-carbon-monoxide-co-outdoor-air-pollution). Some air pollutants, such as, ground-level ozone are created via a chemical reaction between nitrogen oxides (NO_x), volatile organic compounds (VOC), and sunlight [(EPA)](https://www.epa.gov/ground-level-ozone-pollution/ground-level-ozone-basics). During summer months O3 levels tend to peak due to regions with elevated NOX emissions. Areas with high traffic levels, NO_x reacts to ground-level O3 showing a reduction of O3 concentrations. Moreover, areas such as city centers or areas with NO_x emission show lower O3 levels [(EHDP)](https://a816-dohbesp.nyc.gov/IndicatorPublic/beta/key-topics/airquality/nyccas/). PM2.5, a prevalent air pollutant, originates from both outdoor and indoor environments. Outdoor sources comprise of vehicle emissions, gas, and fires, while indoor contributors encompass tobacco smoke, candle combustion, and oil lamps [(NYSD)](https://www.health.ny.gov/environmental/indoors/air/pmq_a.htm). 

Long term and short term exposure to the pollutants discussed above is associated with a number of health concerns such as respiratory diseases and heart attacks [(EPA)](https://www.epa.gov/report-environment/air#:~:text=Air%20pollution%2C%20whether%20indoors%20or,respiratory%20symptoms%2C%20and%20premature%20mortality.). For example, high levels of O3 can pose a great risk with those suffering from asthma [(EPA)](https://www.epa.gov/ground-level-ozone-pollution/ground-level-ozone-basics). According to the New York State Department of Heath, in-taking high levels of PM2.5 can increase the risk for health problems [(NYSD)](https://www.health.ny.gov/environmental/indoors/air/pmq_a.htm). 

### Initial Questions
While the data we used changed as our analyses progressed, our main guiding questions have remained the same throughout the project. Namely, where is air quality the worst in NYC? and how is air quality associated with the incidence of respiratory disease/hospitalizations throughout the city?

### Related Work 

In a study evaluating the potential decrease in greenhouse gas (GHG) emissions, in relation to air quality and public health in NYC, the suggested policy measures may result in an annual reduction of 160 to 390 deaths attributed to PM2.5. Neighborhoods characterized by higher poverty levels showed a more pronounced health gain [(Johnson, S. 2020)](https://pubs.acs.org/doi/10.1021/acs.est.0c00694). In a study focusing on PM2.5 levels, the potential health benefits for adults and children were assessed. Outcomes such as preterm birth, low birthweight, infant mortality, asthma incidence, hospital admissions, emergency visits, and autism spectrum disorder were considered. A estimated 23% improvement in PM2.5 was calculated, thus leading to avoided illness cases and death. Furthermore, for the period of 2021-2025, the estimated associated economic benefit ranged from \$31.8 billion and \$77 billion [(Perera, F. 2021)](https://www.sciencedirect.com/science/article/pii/S0013935120314523?via%3Dihub). Ambient PM2.5 attributed deaths increased from 3.5 million in 1990 to 4.2 million in 2015. In 2015, the fifth-ranking cause of global deaths was ambient PM2.5 [PM2.5 related deaths](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5439030/). In a study following the PM2.5 concentration in NYC from 2015-2020, similar decrease levels between January and May were observed. There was less air pollutant in 2020 that could have been due to the government shutdown during the corona virus pandemic could not be confirmed[COVID shutdown](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7314691/#bb0010). 
The findings of a study investigating the interactive effects of PM2.5 and O3 on daily mortality, showed a synergistic effect in total, cardiovascular, and respiratory mortality.In relation to respiratory mortality, PM2.5 had a higher impacted on cases in higher altitudes with higher O3 exposure [(Liu, C.)](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC10548261/). 


## **Methods and Exploratory Analysis** 
### Data Sources
The initial air quality dataset was obtained from [NYC Open Data](https://data.cityofnewyork.us/Environment/Air-Quality/c3uy-2p5r), showing comprehensive information on air pollutants in NYC from 2008 to 2021. The year range 2010 to 2021 was chosen for analysis. This dataset solely includes measurements on a seasonal and yearly basis, hence presented with time gaps in the data. This unfortunately restricts our ability to perform a thorough time-series analysis, thus a subsequent air quality data set consisting of daily measurements was obtained to support our analysis. The second dataset was downloaded from [EPA](https://www.epa.gov/outdoor-air-quality-data/download-daily-data). 
[add info about dataset]

The initial health dataset obtained from [NYC Open Data](https://data.cityofnewyork.us/Health/Emergency-Department-Visits-and-Admissions-for-Inf/2nwg-uqyg), specified emergency department visits, admissions and visits related to influenza-like and/or pneumonia illness, categorized by the modified ZIP code. A secondary disease data set from [NYC Health](https://a816-health.nyc.gov/hdi/epiquery/visualizations?PageType=ps&PopulationSource=Syndromic) detailed the number of hospitalizations attributed to asthma, diarrhea, influenza-like illness, respiratory diseases, and vomiting for each zip code. The data collection period occurred during 2016 to early 2023. Since this data is very large, we had to restrict the dates of data collection prior to downloading a CSV file.

While all of our datasets contained some level of location data, we needed additional information on zip codes and neighborhoods to perform our analyses. In particular, we needed to standardize zip codes throughout all of our datasets while also adding latitude and longitude for our leaflet maps. Information on zip codes was found [in this github repo](https://github.com/erikgregorywebb/nyc-housing/blob/master/Data/nyc-zip-codes.csv), while zip code shapefiles were found [here](https://catalog.data.gov/dataset/tiger-line-shapefile-2019-2010-nation-u-s-2010-census-5-digit-zip-code-tabulation-area-zcta5-na). We also used shapefiles, available [here](https://github.com/nycehs/NYC_geography/tree/master/UHF_42_DOHMH_2009), to plot the air quality values into maps and for regressions of daily observsations.

### Data Cleaning 
Two air quality and two disease data sets were obtained for analysis. [AIR QUALITY (SEASONAL) ONE CLEANING]. [AIR QUALITY (DAILY)]. 
Two disease data sets. [1] and [2]


DF for Interactive Histogram and Boxplot
```{r, message = FALSE}

# Load datasets for interactive histogram and boxplot

df_histo_pm2.5 = 
  read_csv("data/cleaned_data/uhf_airquality.csv") |> 
  filter(str_detect(time_period, "Annual Average")) |> 
  mutate(year = str_extract(time_period, "\\d{4}")) |> 
  filter(name == "Fine particles (PM 2.5)",
         year != 2009) |> 
  select(year, data_value)

df_histo_NO2 = 
  read_csv("data/cleaned_data/uhf_airquality.csv")  |> 
  filter(str_detect(time_period, "Annual Average")) |> 
  mutate(year = str_extract(time_period, "\\d{4}")) |> 
  filter(name == "Nitrogen dioxide (NO2)",
         year != 2009) |> 
  select(year, data_value) 

df_histo_ozone =
  read_csv("data/cleaned_data/uhf_airquality.csv")  |> 
  filter(name == "Ozone (O3)") |> 
  mutate(year = str_extract(time_period, "\\d{4}")) |> 
  select(year, data_value) |> 
  filter(year != 2009)
```


DF for Interactive Heatmaps
```{r,  message = FALSE, warning = FALSE}
df_air_geo = 
  read_csv("data/cleaned_data/uhf_airquality.csv") |> 
  mutate(lat = intplat10,
         lon = intplon10) |> 
  select(-intplat10, -intplon10)
```

DF for Boxplots according to Borough
```{r message = FALSE}
daily_air = read_csv(here::here("data/raw_data/alt_air_data.csv")) %>%
  mutate(borough = case_when(
    county == "New York" ~ "Manhattan",
    county == "Bronx" ~ "Bronx",
    county == "Kings" ~ "Brooklyn",
    county == "Queens" ~ "Queens",
    county == "Richmond" ~ "Staten Island"
     ),
    pollutant= case_when(
    pollutant == "PM2.5" ~ "PM 2.5",
    pollutant == "Ozone" ~ "O3",
    T ~ pollutant )) %>% 
  filter(pollutant != "CO") %>%
  mutate(
    pollutant = str_c(pollutant, " (", units, ")")
  )
  
```

DF for time series by neighboorhood 
```{r, warning = FALSE}
#this data maps measurement sites to neighborhoods

sites_nghbors = read_csv(here::here("data/cleaned_data/pollutant_per_neighborhood.csv"))
```

```{r message = FALSE}
#Where Fresh Meadows is Queens and Willowbrook is in Staten Island
#Hunts Point - Mott Haven is in Bronx

#my neighborhoods on interest:

neighborhoods = c("Washington Heights", "Union Square - Lower East Side",
                  "Willowbrook", "Hunts Point - Mott Haven", "Fresh Meadows")

store_data = vector("list", length = 5)

for (i in 1:length(neighborhoods)) {
  
  n = neighborhoods[i]
  
  n_zips = sites_nghbors %>%
  filter(geo_place_name == n) %>%
  pull(zip_code)
  
  daily_data = daily_air %>%
    filter(zip_code %in% n_zips) %>%
    group_by(date, pollutant) %>%
    summarize(mean_value = mean(value),
              mean_scaled = mean(scaled_value)) %>%
    mutate(neighborhood = n)
  
  store_data[[i]] = daily_data
  
}
```

```{r, warning = FALSE}
daily_neighborhood_data = bind_rows(store_data[[1]], store_data[[2]]) %>%
  bind_rows(store_data[[3]]) %>%
  bind_rows(store_data[[4]]) %>%
  bind_rows(store_data[[5]]) %>%
  mutate(date = as.Date(date, format = "%m/%d/%Y"))
```

DF EDA Disease 
```{r, warning = FALSE}
#loading disease data
disease_zip <- read_csv(here::here('data/cleaned_data/disease_zip.csv'))
#loading zip code data
zip_shapes <- read_csv(here::here('data/cleaned_shapes/nyc_zip_codes.csv')) %>%
  clean_names()
#cleaning second disease data
joined_resp <- read_csv(here::here('data/raw_data/joined_respiratory.csv'),
                        col_types = cols(
                          `date` = col_date(format = '%m/%d/%y'))) %>%
  separate(date, into = c('year', 'month', 'day')) %>%
  rename(zip_code = zip) %>%
  filter(!(zip_code == 'Citwide'),
         !(zip_code == '88888'),
         age_group == 'All age groups') %>%
  mutate(month = case_when(
    month == '01' ~ 'January',
    month == '02' ~ 'February',
    month == '03' ~ 'March',
    month == '04' ~ 'April',
    month == '05' ~ 'May',
    month == '06' ~ 'June',
    month == '07' ~ 'July',
    month == '08' ~ 'August',
    month == '09' ~ 'September',
    month == '10' ~ 'October',
    month == '11' ~ 'November',
    month == '12' ~ 'December'),
    
    year = as.integer(year),
    zip_code = as.double(zip_code))
#joining 2nd option (full_join)
disease_data <- full_join(disease_zip, joined_resp, by = c('zip_code', 'year', 'month', 'day')) %>%
  #deleting unness. columns
  select(-extract_date, -age_group, -borough, -neighborhood)
#adding missing zip code
disease_data <- left_join(disease_data, zip_shapes, by = 'zip_code') %>%
  mutate(
    neighborhood = case_when(
      zip_code == '10069' ~ 'Upper West Side',
      zip_code == '11109' ~ 'Northwest Queens',
      zip_code == '10282' ~ 'Lower Manhattan',
      zip_code == '10271' ~ 'Lower Manhattan',
      zip_code == '10278' ~ 'Lower Manhattan',
      zip_code == '10279' ~ 'Lower Manhattan',
      #zip_code == '11003' ~ 10000 (deal w these)
      #zip_code == '11040'
      TRUE ~ neighborhood),
  
    borough = case_when(
      zip_code == '10069' ~ 'Manhattan',
      zip_code == '11109' ~ 'Queens',
      zip_code == '10282' ~ 'Manhattan',
      zip_code == '10271' ~ 'Manhattan',
      zip_code == '10278' ~ 'Manhattan',
      zip_code == '10279' ~ 'Manhattan',
      TRUE ~ borough)) %>%
  
  filter(!(zip_code == '10000'),
         !(zip_code == '11003'),
         !(zip_code == '11040'))

disease_eda <- disease_data %>%
  pivot_longer(cols = 'total_ed_visits':'count_asth',
               names_to = 'illness_counts',
               values_to = 'count') %>%
  mutate(month_num = match(month, month.name),
         date = as.Date(paste(year, month_num, day, sep = '-'),
                        format = '%Y-%m-%d'),
         
         illness_counts = case_when(
           illness_counts == 'total_ed_visits' ~ 'ED visits (overall)',
           illness_counts == 'ili_pne_visits' ~ 'Pneumonia (ER visits)',
           illness_counts == 'ili_pne_admissions' ~ 'Pneumonia (ER admissions)',
           illness_counts == 'count_resp' ~ 'Respiratory diseases',
           illness_counts == 'count_asth' ~ 'Asthma'))
```

DF for time series
```{r, warning = FALSE, message = FALSE}
#neighborhoods of interest
neighborhoods = c("Inwood and Washington Heights", "Lower East Side",
                  "Mid-Island", "Hunts Point and Mott Haven", "Central Queens")

daily_disease_neigh = disease_eda %>%
  filter(neighborhood %in% neighborhoods) %>%
  group_by(date, borough, neighborhood, illness_counts) %>% 
  summarize(total_counts = sum(count, na.remove = T)) %>%
  #need neighborhood names to match
  mutate(neighborhood = case_when( 
    neighborhood == "Inwood and Washington Heights" ~ "Washington Heights",
    neighborhood == "Lower East Side"  ~  "Union Square - Lower East Side",
    neighborhood ==  "Mid-Island" ~ "Willowbrook",
    neighborhood == "Hunts Point and Mott Haven" ~ 
      "Hunts Point - Mott Haven",
    neighborhood == "Central Queens" ~"Fresh Meadows"
  ),
  date = as.Date(date, format = '%Y-%m-%d'))
```



### Exploratory Analysis and Visualizations

O3, PM2.5, and NO2 were the air pollutants chosen for our descriptive and statistical analysis. 

#### Histogram and boxplot of air quality from 2010-2021
An interactive histogram showing each air pollutant concentration, overlaid from the years 2009-2021, was constructed to depict frequency distribution and central tendency. Additionally, the spread, central tendency, and presence of outliers were shown in an interactive box plot based on air pollutant and year. PM2.5 and NO2 concentrations continuously declined from 2009 to 2021, as evident on the layered histogram and box plots. PM2.5 showed an emphasized decrease in concentration, with the lowest median concentration exhibited in 2020.O3 concentrations initially increased from 2010 to 2016, but seemed to stabilize around 30 ppb with observed measurement decreases from 2017 to 2021. 

```{r, warning = FALSE}
all_years = sort(unique(c(as.numeric(df_histo_pm2.5$year),
                           as.numeric(df_histo_NO2$year),
                           as.numeric(df_histo_ozone$year))))

combined_fig = plot_ly()


pollutants_data = list(df_histo_pm2.5, df_histo_NO2, df_histo_ozone)
pollutant_names = c("PM2.5", "NO2", "O3")
pollutant_units = c("PM2.5 Concentration (mcg/m3)", "NO2 Concentration (ppb)", "O3 Concentration (ppb)")


for(i in seq_along(pollutants_data)) {

  for(year_value in all_years) {
    year_data = filter(pollutants_data[[i]], year == as.character(year_value))
    combined_fig = combined_fig |>
      add_histogram(data = year_data, 
                    x = ~data_value, 
                    name = as.character(year_value),
                    marker = list(opacity = 0.6),
                    visible = i == 1) 
  }
}

num_years = length(all_years)
buttons = lapply(seq_along(pollutants_data), function(i) {
  visibility = c(rep(FALSE, num_years * (i - 1)), 
                 rep(TRUE, num_years), 
                 rep(FALSE, num_years * (length(pollutants_data) - i)))
  list(method = "update",
       args = list(list("visible" = visibility),
                   list("title" = paste(pollutant_names[i], "Concentration"),
                        "xaxis.title" = pollutant_units[i])),
       label = pollutant_names[i])
})

combined_fig = combined_fig |>
  layout(title = "Comparison of Pollutant Concentrations",
         barmode = "overlay",
         xaxis = list(title = "Concentration"),
         yaxis = list(title = 'Count of Measurements'),
         updatemenus = list(list(type = "dropdown", buttons = buttons)))

combined_fig
```

```{r, warning = FALSE}
add_yearly_boxplots = function(data, years, name_prefix, visible) {
  for(year_value in years) {
    year_data = filter(data, year == as.character(year_value))
    combined_boxplot_fig <<- combined_boxplot_fig |>
      add_trace(data = year_data, 
                y = ~data_value, 
                type = 'box',
                name = paste(name_prefix, year_value),
                visible = visible)
  }
}


combined_boxplot_fig = plot_ly()


add_yearly_boxplots(df_histo_pm2.5, all_years, "PM2.5", TRUE)

add_yearly_boxplots(df_histo_NO2, all_years, "NO2", FALSE)
add_yearly_boxplots(df_histo_ozone, all_years, "O3", FALSE)


buttons = lapply(seq_along(pollutants_data), function(i) {
  visibility = c(rep(i == 1, num_years), rep(i == 2, num_years), rep(i == 3, num_years))
  list(
    method = "update",
    args = list(
      list("visible" = visibility),
      list(
        "title" = paste(pollutant_names[i], "Concentration"),
        "yaxis.title" = pollutant_units[i]
      )
    ),
    label = pollutant_names[i]
  )
})


combined_boxplot_fig = combined_boxplot_fig |>
  layout(
    title = "Comparison of Pollutant Concentrations (Boxplots)",
    yaxis = list(title = pollutant_units[1]), 
    updatemenus = list(list(type = "dropdown", buttons = buttons))
  )

combined_boxplot_fig

```

#### Heatmaps of air quality from 2010-2021

A heat map of the air pollutants with a year selector was constructed to monitor and understand the air quality in NYC. High concentrations of the selected pollutant were indicated by red and maroon, while lower concentrations were shown in green. The PM2.5 heat map showed a greater amount of PM2.5 levels in Lower Manhattan throughout the years. Comparing 2009 to 2021, the levels in each area show a decline in PM2.5 levels. Outer boroughs such as Brooklyn showed consistently high concentrations of O3 levels from 2009 to 2021. NO2 displayed a decrease in concentration however it was less noticeable. 

```{r, echo = FALSE, message = FALSE, warning = FALSE}
library(tidyverse)
library(leaflet)
library(plotly)
library(glue)
library(leaflet.extras)

df_air_geo = 
  read_csv("data/cleaned_data/uhf_airquality.csv") |> 
  mutate(lat = intplat10,
         lon = intplon10) |> 
  select(-intplat10, -intplon10)
```

**2010-2021: Ozone levels (O3)**

Based on the heatmap, it appears that ozone levels are generally at their lowest in Lower Manhattan, particularly in Chelsea (Clinton) and Gramercy Park (Murray Hill). High O3 levels are seen in coastal areas such as the Rockaway Peninsula, where the Gateway National Recreation Area is located. This makes sense since ozone forms at ground level when nitrogen oxides (such as NO2) react with sunlight, a process that accelerates in warmer temperatures and with increased UV-light exposure. From our map, there does not appear to be any apparent trend in ozone levels between 2010 and 2021 and levels seem to oscillate without any pattern. This is lower than the standard of 70 ppb by [the U.S. Environmental Protection Agency (EPA)](https://www.epa.gov/sites/default/files/2015-10/documents/overview_of_2015_rule.pdf). A standard of 70 ppb is below the level that causes adverse health effects in the clinical studies, which essentially eliminates exposures that have been shown to cause adverse health effects, protecting 99.5% of children from even single exposures to ozone at 70 ppb. The highest mean from our data is 40.3 ppb, which is much lower than the standard.

```{r, out.width = '100%', message = FALSE, warning = FALSE}
# Extract ozone data
o3_data = df_air_geo |> 
  filter(str_detect(name, "Ozone") & str_detect(name, "\\(")) |> 
  mutate(start_date = as.Date(start_date, format = "%m/%d/%Y"),
         year = year(start_date),
         name = str_remove(name, "(due to).*")) |> 
  select(geo_place_name, name, measure, measure_info, year, data_value, lat, lon) |> 
  group_by(geo_place_name, name, year, lat, lon) |> 
  summarize(zipmean = mean(data_value)) |> 
  filter(year != 2009)

# Create yearly dataframes
yearly_data_frames <- list()
for (k in 2010:2021) {
  year_data = o3_data |> 
    filter(year == k)
  df_name = paste0("o3_", k)
  assign(df_name, year_data)
  yearly_data_frames[[as.character(k)]] = year_data
}

# Create map

palette <- c("#39FF14", "#FFFF33", "#FF7F00", "#E31A1C", "#9F0000")
legend <- c("21.0-25.0", "25.1-30.0", "30.1-35.0", "35.1-40.0", ">40")

m = leaflet() |> addTiles()

year_i = unique(o3_data$year)
for(year in year_i) {
  
  
  yeardata = o3_data[o3_data$year == year,]
  
  
  label_text <- glue(
    "<b>Neighborhood: </b> {yeardata$geo_place_name}<br/>",
    "<b>Year: </b> {yeardata$year}<br/>",
    "<b>Mean: </b> {yeardata$zipmean} ppb<br/>") |> 
    lapply(htmltools::HTML)
  
  
  m = m |>
    addCircleMarkers(data = yeardata, lng = ~lon, lat = ~lat, radius = .5, opacity = 0.8, 
                     color = ~ifelse(between(zipmean, 21, 25), "#39FF14", 
                                     ifelse(between(zipmean, 25.001, 30), "#FFFF33", 
                                            ifelse(between(zipmean, 30.001, 35),"#FF7F00",
                                                   ifelse(between(zipmean, 35.001, 40), "#E31A1C","#9F0000")))),
                     label = label_text, group = as.character(year))
}

m = m |> 
  addHeatmap(data = yeardata,lng = ~lon, lat = ~lat, 
             intensity = 2, blur = 5, max = 4, radius = 10, 
             group = "Heatmap Overlay") |> 
  addLegend(labels = legend, colors = palette, title = "Ozone levels (parts per billion)") |> 
  addLayersControl(overlayGroups = "Heatmap Overlay",
                   baseGroups = year_i,
                   options = layersControlOptions(collapsed = FALSE)) 

m
```


**2010-2021: Fine Particles PM2.5**

From our map, we see that some of the highest levels of PM2.5 are seen in Lower Manhattan. This makes sense, as we would anticipate that traffic congestion would lead to rising vehicle emissions and subsequently higher concentrations of PM2.5. Unlike O3, however, PM2.5 concentrations generally look to decrease from 2010-2021, especially in neighborhoods that are away from the city. This reflects similar trends seen in previous EDA performed on the data. PM2.5 seems to be the lowest in 2020, which could be due to lower congestion levels during COVID. That being said, there is some year-to-year variability and some clusters of zip codes exhibit high levels as late as 2021. Following the [standards by the U.S. Environmental Protection Agency (EPA)](https://www.epa.gov/sites/default/files/2016-04/documents/2012_aqi_factsheet.pdf), the primary annual PM2.5 standards is set to 12 micrograms per cubic meter (µg/m3). Exposure to fine particle pollution can cause premature death and harmful cardiovascular effects such as heart attacks and strokes, and is linked to a variety of other significant health problems. From our maps, we do observe areas with PM2.5 levels higher than this standard, especially in neighborhoods in Lower Manhattan. 

```{r, out.width = '100%', message = FALSE, warning = FALSE}
# Extract pm2.5 data
pm25_data = df_air_geo |> 
  filter(str_detect(name, "Fine")) |> 
  mutate(start_date = as.Date(start_date, format = "%m/%d/%Y"),
         year = year(start_date),
         name = str_remove(name, "(due to).*")) |> 
  select(geo_place_name, name, measure, measure_info, year, data_value, lat, lon) |> 
  group_by(geo_place_name, name, year, lat, lon) |> 
  summarize(zipmean = mean(data_value)) |> 
  filter(year != 2008 & year != 2009)

# Create yearly dataframes
yearly_data_frames <- list()
for (k in 2010:2021) {
  year_data = pm25_data |> 
    filter(year == k)
  df_name = paste0("pm25_", k)
  assign(df_name, year_data)
  yearly_data_frames[[as.character(k)]] = year_data
}

# Create map

palette <- c("#39FF14", "#FFFF33", "#FF7F00", "#E31A1C", "#9F0000", "#660000")
legend <- c("5.0-7.0", "7.1-9.0", "9.1-11.0", "11.1-13.0", "13.1-15.0", ">15")

m = leaflet() |> addTiles()

year_i = unique(pm25_data$year)
for(year in year_i) {
  
  
  yeardata = pm25_data[pm25_data$year == year,]
  
  
  label_text <- glue(
    "<b>Neighborhood: </b> {yeardata$geo_place_name}<br/>",
    "<b>Year: </b> {yeardata$year}<br/>",
    "<b>Mean: </b> {round(yeardata$zipmean,3)} mcg/m3<br/>") |> 
    lapply(htmltools::HTML)
  
  
  m = m |>
    addCircleMarkers(data = yeardata, lng = ~lon, lat = ~lat, radius = .5, opacity = 0.8, 
                     color = ~ifelse(between(zipmean, 5, 7), "#39FF14", 
                                     ifelse(between(zipmean, 7.001, 9), "#FFFF33", 
                                            ifelse(between(zipmean, 9.001, 11),"#FF7F00",
                                                   ifelse(between(zipmean, 11.001, 13), "#E31A1C",
                                                          ifelse(between(zipmean, 13.001, 15), "#9F0000", "#660000"))))),
                     label = label_text, group = as.character(year))
}

m = m |> 
  addHeatmap(data = yeardata,lng = ~lon, lat = ~lat, 
             intensity = 2, blur = 5, max = 4, radius = 10, 
             group = "Heatmap Overlay") |> 
  addLegend(labels = legend, colors = palette, title = "PM2.5 levels (mcg/m3)") |> 
  addLayersControl(overlayGroups = "Heatmap Overlay",
                   baseGroups = year_i,
                   options = layersControlOptions(collapsed = FALSE)) 

m
```


**2010-2021: Nitrogen dioxide (NO2)**

Similar to PM2.5, NO2 levels seem to be at their highest throughout Manhattan, especially in Lower Manhattan. It appears that NO2 levels in boroughs surrounding Manhattan decrease between 2010 and 2021, with South Beach and the Rockaway Peninsula showing lowest NO2 levels throughout the years. The [official level of the annual NO2 standard](https://www.epa.gov/no2-pollution/timeline-nitrogen-dioxide-no2-national-ambient-air-quality-standards-naaqs#:~:text=The%20official%20level%20of%20the,to%20the%201%2Dhour%20standard.&text=The%20form%20of%20the%201,daily%20maximum%20NO2%20concentrations.) is 53 ppb, and our maximum NO2 levels among all neighborhoods and years is 39.8 ppb.

```{r, out.width = '100%', message = FALSE, warning = FALSE}
# Extract NO2 data
no2_data = df_air_geo |> 
  filter(str_detect(name, "Nitrogen")) |> 
  mutate(start_date = as.Date(start_date, format = "%m/%d/%Y"),
         year = year(start_date),
         name = str_remove(name, "(due to).*")) |> 
  select(geo_place_name, name, measure, measure_info, year, data_value, lat, lon) |> 
  group_by(geo_place_name, name, year, lat, lon) |> 
  summarize(zipmean = mean(data_value)) |> 
  filter(year != 2008 & year != 2009)

# Create yearly dataframes
yearly_data_frames <- list()
for (k in 2010:2021) {
  year_data = no2_data |> 
    filter(year == k)
  df_name = paste0("no2_", k)
  assign(df_name, year_data)
  yearly_data_frames[[as.character(k)]] = year_data
}

# Create map

palette <- c("#39FF14", "#FFFF33", "#FF7F00", "#E31A1C", "#9F0000", "#660000")
legend <- c("5.0-10.0", "10.1-15.0", "15.0-20.1", "20.1-25.0", "25.1-30.0", ">30")

m = leaflet() |> addTiles()

year_i = unique(no2_data$year)
for(year in year_i) {
  
  
  yeardata = no2_data[no2_data$year == year,]
  
  
  label_text <- glue(
    "<b>Neighborhood: </b> {yeardata$geo_place_name}<br/>",
    "<b>Year: </b> {yeardata$year}<br/>",
    "<b>Mean: </b> {round(yeardata$zipmean,3)} ppb<br/>") |> 
    lapply(htmltools::HTML)
  
  
  m = m |>
    addCircleMarkers(data = yeardata, lng = ~lon, lat = ~lat, radius = .5, opacity = 0.8, 
                     color = ~ifelse(between(zipmean, 5, 10), "#39FF14", 
                                     ifelse(between(zipmean, 10.001, 15), "#FFFF33", 
                                            ifelse(between(zipmean, 15.001, 20),"#FF7F00",
                                                   ifelse(between(zipmean, 20.001, 25), "#E31A1C",
                                                          ifelse(between(zipmean, 25.001, 30), "#9F0000", "#660000"))))),
                     label = label_text, group = as.character(year))
}

m = m |> 
  addHeatmap(data = yeardata,lng = ~lon, lat = ~lat, 
             intensity = 2, blur = 5, max = 4, radius = 10, 
             group = "Heatmap Overlay") |> 
  addLegend(labels = legend, colors = palette, title = "NO2 levels (parts per billion)") |> 
  addLayersControl(overlayGroups = "Heatmap Overlay",
                   baseGroups = year_i,
                   options = layersControlOptions(collapsed = FALSE)) 

m
```


#### Plots for pollutant variables over time by site

Now that we have looked at how pollution levels change over the years, let's examine the pollution variables at a more granular level. In this data, we have 18,452 rows, where each row is a date-measurement site-pollutant combination.

After restricting our analysis to roughly 2020 to 2022, visualizations of the distributions of certain pollutants of interest were generated. Throughout the year, we see oscillations in the levels of Ozone (O3) and Nitrogen Dioxide (NO2) throughout the year, with the former reaching its highest levels in the summer months and the latter peaking in the winter. Carbon Monoxide (CO) also exhibits oscillations, but to a much lower degree. PM2.5, a type of fine particulate matter with 2.5 microns or less in diameter, does not appear to exhibit a seasonal pattern. 

This makes sense intuitively, as we would expect higher emissions from heating and transportation to gather in urban regions due to colder temperatures, leading to higher levels of Nitrogen Dioxide and Carbon Monoxide. In fact, [epidemics of CO poisoning](https://pubmed.ncbi.nlm.nih.gov/9950394/) commonly occurs during winter months and sources include smoke from fires, fumes from heating systems burning fuels, and exhaust fumes from motor vehicles. On the other hand, according to the [American Lung Association](https://www.lung.org/clean-air/outdoors/what-makes-air-unhealthy/ozone#), high levels of Ozone are more likely to form in warmer temperatures, which is why harmful ozone levels primarily occur in the summer in most of the US because climate change is driving warmer temperatures.

```{r, out.width = '100%', message = F}
daily_air = read_csv(here::here("data/raw_data/alt_air_data.csv")) %>%
  mutate(borough = case_when(
    county == "New York" ~ "Manhattan",
    county == "Bronx" ~ "Bronx",
    county == "Kings" ~ "Brooklyn",
    county == "Queens" ~ "Queens",
    county == "Richmond" ~ "Staten Island"
     ),
    pollutant= case_when(
    pollutant == "PM2.5" ~ "PM 2.5",
    pollutant == "Ozone" ~ "O3",
    T ~ pollutant ),
    date = as.Date(date, format = "%m/%d/%Y")) %>% 
  mutate(
    pollutant = str_c(pollutant, " (", units, ")")
  )

poll_plot = daily_air |> 
  ggplot(aes(x = date, y = value, color = pollutant)) +
  geom_point() +
  geom_smooth(color = "blue") +
  facet_wrap(~ pollutant, ncol = 2, scales="free_y") +
  ggtitle("Daily average of each pollutant by site") + 
  scale_color_discrete()

poll_plot
```


#### Boxplots of daily air pollutants by borough

The frequency distribution of daily air pollutant concentrations in regard to borough was shown in boxplots. NO2 and PM2.5 showed consistent daily medians throughout each borough. O3 showed a slightly elevated daily concentration median in Staten Island compared to other boroughs. 

```{r, warning = FALSE}
daily_air %>%
  ggplot() + geom_boxplot(aes(x = borough, y = value, fill = borough)) + 
  labs(x = "Borough", y = "Measurement value", fill = "Borough") +
  theme(axis.text.x  = element_text(angle=15)) +
  facet_wrap(~pollutant, scales = 'free')
```


#### Time series plots on daily air pollutants by neighborhood 

In the context of these time series plots, the daily mean measurement of each pollutant, categorized by neighborhoods, was derived and depicted as a distinctive line. Coherent patterns were observed for each pollutant in these neighborhoods. NO2 displayed its pinnacle reach during the winter and spring transitions, where as O3 sowed its highest vales in the summer months. These visual representation shows and highlights the nuanced temporal fluctuation between the pollutants. 

```{r}
neighborhoods = c("Washington Heights", "Union Square - Lower East Side",
                  "Willowbrook", "Hunts Point - Mott Haven", "Fresh Meadows")

store_data = vector("list", length = 5)

for (i in 1:length(neighborhoods)) {
  
  n = neighborhoods[i]
  
  n_zips = sites_nghbors %>%
  filter(geo_place_name == n) %>%
  pull(zip_code)
  
  daily_data = daily_air %>%
    filter(zip_code %in% n_zips) %>%
    group_by(date, pollutant) %>%
    summarize(mean_value = mean(value),
              mean_scaled = mean(scaled_value)) %>%
    mutate(neighborhood = n)
  
  store_data[[i]] = daily_data
  
}

daily_neighborhood_data = bind_rows(store_data[[1]], store_data[[2]]) %>%
  bind_rows(store_data[[3]]) %>%
  bind_rows(store_data[[4]]) %>%
  bind_rows(store_data[[5]]) %>%
  mutate(date = as.Date(date, format = "%m/%d/%Y"))
```


```{r, warning = FALSE}
daily_neighborhood_data %>%
  filter(pollutant == "NO2 (ppb)") %>%
  ggplot() + geom_line(aes(x = date, y = mean_value,
                            group = neighborhood, color = neighborhood)) +
  scale_color_manual(values = c("red", "blue", 
                                    "green","orange", 
                                    "black")) +
  labs(title = "NO2 measurements per neighborhood", x = "Date", 
       y = "Mean measurement (ppb)", color = "Neighborhood")
```


```{r, warning = FALSE}
daily_neighborhood_data %>%
  filter(pollutant == "O3 (ppm)") %>%
  ggplot() + geom_line(aes(x = date, y = mean_value,
                            group = neighborhood, color = neighborhood)) +
  scale_color_manual(values = c("red", "blue", 
                                    "green","orange", 
                                    "black")) +
  labs(title = "O3 measurements per neighborhood", x = "Date", 
       y = "Mean measurement (ppm)", color = "Neighborhood")
```

```{r, warning = FALSE}
daily_neighborhood_data %>%
  filter(pollutant == "PM 2.5 (ug/m3 LC)") %>%
  ggplot() + geom_line(aes(x = date, y = mean_value,
                            group = neighborhood, color = neighborhood)) +
  scale_color_manual(values = c("red", "blue", 
                                    "black",
                                    "green","orange")) +
  labs(title = "PM 2.5 measurements per neighborhood", x = "Date", 
       y = "Mean measurement (ug/m3 LC)", color = "Neighborhood")
```


#### Plots for illness variables over time by site

Our analysis also spans from roughly 2020 to 2022. From the plot below, we can see that respiratory diseases, pneumonia-related emergency department visits and admissions all peak during winter seasons, which seems to match up with the time-series plots for Carbon Monoxide and Nitrogen Dioxide. Colds, flus and other respiratory illnesses are common in colder months. Among these variables, [pneumonia](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3314701/) is commonly known have a higher occurrence during winter. This is partly attributed to the drop in temperature and rise in humidity levels, which can impair the immune system thus rendering individuals more vulnerable to infections. The body focuses on combating the cold and retaining warmth, making it more challenging to fend off infections such as pneumonia.

However, we saw previously that Ozone trends in the opposite direction as other pollutants, which prompts our interest in exploring a potential lagged association between Ozone levels and disease occurrences. To investigate this, we have conducted a cross-correlation analysis at the end of this page, as an attempt to test out the idea of lagging certain variables.

```{r, out.width = '100%', message = F, warning = F}
dis_asth_df = read_csv(here::here("data/raw_data/joined_respiratory.csv"),
                       col_types = cols(
                          `date` = col_date(format = '%m/%d/%y'))) |> 
  rename(zip_code = zip) |> 
  filter(zip_code != 88888 & zip_code != "Citwide" & age_group == "All age groups") |> 
  mutate(year = as.numeric(format(date, format = "%Y")),
         month = month.name[as.numeric(format(date, format = "%m"))],
         day = as.numeric(format(date, format = "%d")),
         zip_code = as.numeric(zip_code)) |>
  select(year, month, day, zip_code, count_resp, count_asth) 

# Load dataset with pneumonia data

dis_pneu_df = read_csv(here::here("data/raw_data/disease_hospital_admin.csv"),
                       col_types = cols(
                                     `date` = col_date(format = "%m/%d/%Y"),
                                     `total_ed_visits` = col_integer(),
                                     `ili_pne_visits` = col_integer(),
                                     `ili_pne_admissions` = col_integer())) |> 
  separate(date, into=c("year", "month", "day")) |> 
  mutate(day = as.numeric(day),
         month = month.name[as.numeric(month)],
         year = as.numeric(year)) |> 
  rename(zip_code = mod_zcta) |> 
  select(year, month, day, zip_code, total_ed_visits, ili_pne_visits, ili_pne_admissions)

# Merge two disease datasets

all_dis_df =
  full_join(dis_asth_df, dis_pneu_df, by = c("zip_code", "year", 'month', 'day'))

dis_plot = all_dis_df |>
  pivot_longer(cols = c("count_resp", "count_asth", "ili_pne_visits", "ili_pne_admissions"), 
               names_to = "variable",
               values_to = "count") |> 
  mutate(variable = case_when(
      variable =="count_resp" ~ "Respiratory diseases",
      variable =="count_asth" ~ "Asthma",
      variable =="ili_pne_visits" ~ "Pneumonia (ER visits)",
      variable =="ili_pne_admissions" ~ "Pneumonia (admissions)"),
      across(variable, ~factor(., levels=c("Asthma","Respiratory diseases",
                                           "Pneumonia (ER visits)",
                                           "Pneumonia (admissions)"))),
      month_num = match(month, month.name),
         date = as.Date(paste(year, month_num, day, sep = '-'),
                        format = '%Y-%m-%d'))|> 
  ggplot(aes(x = date, y = count, color = variable)) +
  geom_point() +
  geom_smooth(color = "blue") +
  facet_wrap(~ variable, ncol = 2, scales="free_y") +
  ggtitle("Daily counts of disease variables by site") + 
  scale_color_discrete()

dis_plot
```


#### Histogram of illnesses counts

The distribution of disease counts and overall ER visits were graphed. Majority of illness counts are zero inflated, thus their distributions are right skewed. The only distribution with more variability is for ER visits (overall).

```{r, out.width = '100%', message = F, warning = F}
# loading zip code data
zip_shapes <- read_csv(here::here('data/cleaned_shapes/nyc_zip_codes.csv')) %>%
  clean_names()

# merging disease with zip code data to add neigh & borough data

all_dis_df <- left_join(all_dis_df, zip_shapes, by = 'zip_code') %>%
  mutate(
    #these zip codes needed manual inputs
    #bc not in zip_shapes file
    neighborhood = case_when(
      zip_code == '10069' ~ 'Upper West Side',
      zip_code == '11109' ~ 'Northwest Queens',
      zip_code == '10282' ~ 'Lower Manhattan',
      zip_code == '10271' ~ 'Lower Manhattan',
      zip_code == '10278' ~ 'Lower Manhattan',
      zip_code == '10279' ~ 'Lower Manhattan',
      #zip_code == '11003' ~ 10000 (deal w these)
      #zip_code == '11040'
      TRUE ~ neighborhood),
    
    borough = case_when(
      zip_code == '10069' ~ 'Manhattan',
      zip_code == '11109' ~ 'Queens',
      zip_code == '10282' ~ 'Manhattan',
      zip_code == '10271' ~ 'Manhattan',
      zip_code == '10278' ~ 'Manhattan',
      zip_code == '10279' ~ 'Manhattan',
      TRUE ~ borough)) %>%
  
  #removing these zip codes bc
  #not apart of the 5 boroughs
  filter(!(zip_code == '10000'),
         !(zip_code == '11003'),
         !(zip_code == '11040'))

disease_eda <- all_dis_df %>%
  pivot_longer(cols = 'count_resp':'ili_pne_admissions',
               names_to = 'illness_counts',
               values_to = 'count') %>%
  mutate(month_num = match(month, month.name),
         date = as.Date(paste(year, month_num, day, sep = '-'),
                        format = '%Y-%m-%d'),
         
         illness_counts = case_when(
           illness_counts == 'total_ed_visits' ~ 'ED visits (overall)',
           illness_counts == 'ili_pne_visits' ~ 'Pneumonia (ER visits)',
           illness_counts == 'ili_pne_admissions' ~ 'Pneumonia (ER admissions)',
           illness_counts == 'count_resp' ~ 'Respiratory diseases',
           illness_counts == 'count_asth' ~ 'Asthma'))


#distribution of illness counts
disease_eda %>%
  ggplot(aes(x = count, fill = illness_counts)) +
  geom_histogram(bins = 15) + 
  facet_wrap(~illness_counts, scales = 'free') +
  theme(legend.position = "none") 

```


#### Boxplots of disease counts by borough

Boxplots of each disease or hospital visits were plotted by borough. Even for boroughs, illness distributions are zero inflated. Again, the ER visits (overall) has more variability among boroughs.

```{r, out.width = '100%', message = F, warning = F}
#distribution of illness counts by neighborhood
disease_eda %>%
  ggplot(aes(x = borough, y = count, fill = borough)) +
  geom_boxplot() +
  facet_wrap(~illness_counts, scales = 'free') +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(legend.position = "none")
```


#### Time series plots on daily disease counts by neighborhoods

Five specific neighborhoods, each in a different borough. The neighborhoods were picked based on the available data for the pollutants.

```{r, out.width = '100%', message = F, warning = F}
#neighborhoods of interest
neighborhoods = c("Inwood and Washington Heights", "Lower East Side",
                  "Mid-Island", "Hunts Point and Mott Haven", "Central Queens")

daily_disease_neigh = disease_eda %>%
  filter(neighborhood %in% neighborhoods) %>%
  group_by(date, borough, neighborhood, illness_counts) %>% 
  summarize(total_counts = sum(count, na.remove = T)) %>%
  #need neighborhood names to match
  mutate(neighborhood = case_when( 
    neighborhood == "Inwood and Washington Heights" ~ "Washington Heights",
    neighborhood == "Lower East Side"  ~  "Union Square - Lower East Side",
    neighborhood ==  "Mid-Island" ~ "Willowbrook",
    neighborhood == "Hunts Point and Mott Haven" ~ 
      "Hunts Point - Mott Haven",
    neighborhood == "Central Queens" ~"Fresh Meadows"
  ),
  date = as.Date(date, format = '%Y-%m-%d'))
```


In the time series plots below, each line represents the total number of hospital visits per day per neighborhood, and each plot presents that information for the different illnesses and total ER visits. 

The plots below further supports that most illness distributions are zero inflated. Specifically, asthma, respiratory diseases. Thus, we decided against using those as responses in regression analysis as prediction may not be accurate. Similarly, we noticed that pneumonia ER admissions consistently had less counts than pneumonia ER visits. And although overall ER visits had more counts, we decided to soley focus on pneumonia ER visits as a response in regression for the purpose of this analysis.


```{r, out.width = '100%', message = F, warning = F}
daily_disease_neigh %>%
  filter(illness_counts == 'Asthma') %>%
  ggplot(aes(x = date, y = total_counts,
             group = neighborhood, color = neighborhood)) +
  geom_line()
```

```{r, out.width = '100%', message = F, warning = F}
daily_disease_neigh %>%
  filter(illness_counts == 'Respiratory diseases') %>%
  ggplot(aes(x = date, y = total_counts,
             group = neighborhood, color = neighborhood)) +
  geom_line()
```

```{r, out.width = '100%', message = F, warning = F}
daily_disease_neigh %>%
  filter(illness_counts == 'Pneumonia (ER visits)') %>%
  ggplot(aes(x = date, y = total_counts,
             group = neighborhood, color = neighborhood)) +
  geom_line()
```

```{r, out.width = '100%', message = F, warning = F}
daily_disease_neigh %>%
  filter(illness_counts == 'Pneumonia (ER admissions)') %>%
  ggplot(aes(x = date, y = total_counts,
             group = neighborhood, color = neighborhood)) +
  geom_line()
```


```{r, out.width = '100%', message = F, warning = F}
daily_disease_neigh %>%
  filter(illness_counts == 'ED visits (overall)') %>%
  ggplot(aes(x = date, y = total_counts,
             group = neighborhood, color = neighborhood)) +
  geom_line()
```



[Similarly, time series plot in regards to daily ER visit and disease counts were generated, showing that asthma and respiratory diseases did not have a seasonal pattern. However, pneumonia ER visits did peak during the winter months. Colds, flus and other respiratory illnesses are common in colder months. Among these variables, [pneumonia](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3314701/) is commonly known have a higher occurrence during winter. This is partly attributed to the drop in temperature and rise in humidity levels, which can impair the immune system thus rendering individuals more vulnerable to infections. The body focuses on combating the cold and retaining warmth, making it more challenging to fend off infections such as pneumonia.]
 



## **Statistical Results** 
Cross correlation analysis was used to examine the relationship between O3 and pneumonia ER visits. From the cross-correlation plots, the positive and negative correlations determined the lag between O3 levels and and pneumonia ER visits was about 117 days. The lag was added as an additional predictor in the linear regression model. There was a negative correlation in pneumonia ER visits and O3 regression model before the lag was added. However, after adding the lag, a positive correlation emerged between pneumonia ER visits and O3. 

```{r}
#altering format
daily_disease_neigh = daily_disease_neigh %>%
  pivot_wider(names_from = illness_counts, values_from = total_counts)

#loading fixed air quality data
air_neighb <- read_csv(here::here('data/cleaned_data/air_neighborhood.csv'))

#altering format
air_neighb = air_neighb %>%
  pivot_wider(names_from = pollutant, values_from = mean_value)

disease_air <- full_join(daily_disease_neigh, air_neighb, 
                         by = c('date', "neighborhood")) %>%
  filter(date >= '2020-03-01' & date < '2022-12-01') %>%
  mutate(year = as.factor(format(date, format = '%Y')),
         month = month.name[as.numeric(format(date, format = "%m"))],
         day = as.numeric(format(date, format = "%d")),
         #adding seasons
         season = case_when(
           month %in% c('June', 'July', 'August') ~ 'Summer',
           month %in% c('September', 'October', 'November') ~ 'Fall',
           month %in% c('December', 'January', 'February') ~ 'Winter',
           month %in% c('March', 'April', 'May') ~ 'Spring'))

disease_air = disease_air %>%
  filter(neighborhood != "Union Square - Lower East Side") %>%
  select(-NO2, -Asthma, -`Respiratory diseases`) %>%
  arrange(date) %>%
  group_by(neighborhood) %>%
  mutate(lagged_ozone = tlag(Ozone, 1, time = date),
         lagged_pm = tlag(PM2.5, 1, time = date)) %>%
  rename( total_ed_visits = `ED visits (overall)`,
          ili_pne_visits = `Pneumonia (ER visits)`)
```

We will now use the merged dataset for modelling. For our dataset, we selected four neighborhoods we were interested in: Washington Heights, Willowbrook, Hunts Point - Mott Haven, and Fresh Meadows. These neighborhoods all have at least one sensor for O3 and PM 2.5, and are all in different boroughs, which are part of the reason why we picked them.

In the final dataset, every one of the `r nrow(disease_air)` rows is a date-neighborhood combination, for dates between March 2020 and November 2022. An important nuance of this modelling section is that we lagged ozone and PM 2.5 readings by one day, which is [the believed time it can take for those pollutants to have an effect on your respiratory health.](https://www.airnow.gov/sites/default/files/2018-04/aqi_brochure_02_14_0.pdf)

### Response variable: Pneumonia ER visits

We first look at the response variable we'll focus on: visits to the hospital due to pneumonia. This variable is discrete and we found that a square root transformation yielded a more Normal distribution

```{r message=FALSE, warning=FALSE}
disease_air = disease_air %>%
  mutate(sqrt_pne_visits = sqrt(ili_pne_visits))

disease_air %>%
  ggplot() + geom_histogram(aes(x= sqrt_pne_visits), fill = "black") + 
  labs(title = 
         "Sqrt(Pneumonia visits) has a more favorable distribution for regression",
       y = "Count",
       x = "Sqrt(Pneumonia visits)")
```

### Choosing predictors

Our next challenge is choosing which variables to use as predictors of `sqrt(pneumonia visits)`. We know from our exploratory data analysis that pollutant levels are associated with date, so including both in the model would be a multicollinearity issue. However, the exploratory data analysis did not reveal an association between boroughs (location) and pollutants, so using both in a model would be appropriate. 

We decided to compare the predictive ability of time and the lagged pollutants by comparing the cross validation root mean square error for 100 cross validation samples. The two models compared will both use `neighborhood` as the predictor, but one will have `season` and `year` (and the interaction between the two), and the other will have lagged ozone and PM 2.5 readings. this process revealed that the time of the year was a better predictor of `sqrt(pneumonia visits)` than the lagged pollutants.

```{r, out.width = '100%', results = 'hide', message = FALSE, warning = FALSE}
modelr::crossv_mc(disease_air, 100) %>%
  mutate(
    pollutants = map(train, \(df) lm(sqrt_pne_visits ~ lagged_ozone + 
                                       lagged_pm + neighborhood, data = df)),
    
    time = map(train, \(df) lm(sqrt_pne_visits ~ year + season + 
                                       year*season +  neighborhood, 
                                        data = df))) %>%
  mutate(
    rmse_pollutants = map2_dbl(pollutants, test, \(mod, df) rmse(model = mod, 
                                                        data = df)),
    
    rmse_time = map2_dbl(time, test, 
                                       \(mod, df) rmse(model = mod, 
                                                             data = df))) %>%
  select(starts_with("rmse")) %>%
  pivot_longer(
    everything(),
    names_to = "model", 
    values_to = "rmse",
    names_prefix = "rmse_") %>%
  mutate(model = fct_inorder(model)) %>%
  ggplot(aes(x = model, y = rmse)) + geom_violin() + 
  labs(title = "RMSE of models predicting sqrt(pneumonia visits)")
```

### Modelling 

After this, we fit the selected model on the entire dataset, and notice that the diagnostics are not good: the residuals clearly have some relationship to the predicted values, but in reality should be nothing more than noise. This motivates bootstrap so we can have interpretable confidence intervals.

```{r, out.width = '100%', results = 'hide', message = FALSE, warning = FALSE}
fit = lm(sqrt_pne_visits ~ year + season + 
                            year*season + neighborhood, 
         data = disease_air)

disease_air %>%
  modelr::add_residuals(fit) %>% 
  modelr::add_predictions(fit) %>%
  ggplot(aes(x = pred, y = resid)) + geom_point() + geom_smooth(se = F) + 
  labs(title = "Our model fails diagnostics", 
       x = "Predicted sqrt(pneumonia visits)", y = "Residuals")
```

```{r message=FALSE, warning=FALSE}
set.seed(42)
bootstrap_results = 
  disease_air %>%
  modelr::bootstrap(n = 5000) %>%
  mutate(
    models = map(strap, \(df) lm(sqrt_pne_visits ~ year + season + 
                            year*season + neighborhood, 
                                        data = df)),
    estimates = map(models, broom::tidy),
    results = map(models, broom::glance)) %>% 
  select(-strap, -models) %>%
  unnest(estimates, results) %>%
  select(term, estimate, r.squared) %>% 
  pivot_wider(names_from = term, values_from = estimate) %>%
pivot_longer(everything(),
             names_to = "estimate", 
               values_to = "value") %>%
  group_by(estimate) %>%
  summarize(
    ci_lower = quantile(value, 0.025, na.rm = T), 
    ci_upper = quantile(value, 0.975, na.rm = T),
    mean = mean(value))
```

#### Bootstrapping 

We did bootstrapping with 5,000 samples, and got an estimated $R^2$ and 95% confidence interval of:

```{r}
bootstrap_results %>%
  filter(estimate == "r.squared") %>%
  knitr::kable(digits = 2)
```

### Interpreting coefficients

Additionally, we are able to interpret the coefficients (holding all else constant):

- Using Fresh Meadows as the reference, we see that Willowbrook has a similar effect on the predicted value of `sqrt(pneumonia)`, because its confidence interval includes 0. Washington Heights is the highest of all values.

```{r, out.width = '100%', results = 'hide', message = FALSE, warning = FALSE}
bootstrap_results %>%
  filter(str_detect(estimate, "neighborhood")) %>%
  mutate(estimate = str_sub(estimate, 13)) %>% 
  mutate(estimate = fct_reorder(estimate, mean)) %>%
  ggplot()  +
  geom_errorbar(aes(x = estimate, ymax = ci_upper, ymin = ci_lower), 
                width=0.2, size=1) + 
  geom_point(aes(x = estimate, y = mean), color = "red") + 
  labs(title = "Neighborhood model coefficients",
       subtitle = "Reference = Fresh Meadows", 
       x = "Coefficient", y = "Estimate")
```

- The predicted number of `sqrt(pneumonia visits)` is on the rise, although the difference between 2020 (reference group) and 2021 is not significant.

```{r}
bootstrap_results %>%
  filter(str_detect(estimate, "year") & !str_detect(estimate, ":")) %>%
  mutate(estimate = str_sub(estimate, 5)) %>% 
  mutate(estimate = fct_reorder(estimate, mean)) %>%
  ggplot()  +
  geom_errorbar(aes(x = estimate, ymax = ci_upper, ymin = ci_lower), 
                width=0.2, size=1) + 
  geom_point(aes(x = estimate, y = mean), color = "red") + 
  labs(title = "Year model coefficients",
       subtitle = "Reference = 2020", 
       x = "Coefficient", y = "Estimate")
```

- Summer season has a significantly lower `sqrt(pneumonia visits)` than Fall (the reference group), while Spring is the highest, followed by Winter.

```{r}
bootstrap_results %>%
  filter(str_detect(estimate, "season") & !str_detect(estimate, ":")) %>%
  mutate(estimate = str_sub(estimate, 7)) %>% 
  mutate(estimate = fct_reorder(estimate, mean)) %>%
  ggplot()  +
  geom_errorbar(aes(x = estimate, ymax = ci_upper, ymin = ci_lower), 
                width=0.2, size=1) + 
  geom_point(aes(x = estimate, y = mean), color = "red") + 
  labs(title = "Season model coefficients",
       subtitle = "Reference = Fall", 
       x = "Coefficient", y = "Estimate")
```



## **Discussion and Conclusions**
### Findings


- Are they what you expect? 
- What insights into the data can you make?

In our data analysis, we found that the model using time variables instead of pollutants to predict `sqrt(pneumonia visits)` was better (as in, lower RMSE). Which means time is more highly correlated to `sqrt(pneumonia visits)` than the lagged pollutant levels. This was unexpected considering the amount of literature on pollutants causing respiratory health complications. 

One reason for this result could be that time is indeed better for predicting `sqrt(pneumonia visits)`: it is already correlated to the pollutant levels (we know this from the EDA) and carries additional information about overall weather. Another reason could be that the linear model is misspecified, because the response is a count (Poisson distribution) and not a Normal distribution. This, combined with the fact that the pollutant levels are continuous variables while the time variables are categorical, might cause higher residuals.

We found that `neighborhood` is a relevant predictor for `sqrt(pneumonia visits)`. A possible reason for this can be the specific conditions of each neighborhood (water quality or number of green areas), but it could also just reflect the fact that some neighborhoods are more densely populated than others. This could be addressed in future research. Whichever the case, we found that Washington Heights is associated with higher `sqrt(pneumonia visits)`, which is relevant given the location of Columbia University’s medical campus. 

Regarding time variables, we found that the Spring season is associated with higher counts of `sqrt(pneumonia visits)`, while the Summer is associated with the least. This agrees with literature that colder seasons (Winter and Spring, our two highest estimates) are associated with respiratory issues. We also found that 2022 was associated with higher `sqrt(pneumonia visits)`, while 2020 was associated with the lower `sqrt(pneumonia visits)`. This could be because of pneumonia cases going up, but could also be a reflection of people isolating during 2020 and not doing so as often anymore. 

### Limitations

Several challenges arose in the analysis related to data processing. The datasets had significant constraints, including limited data, temporal dimensions, and location misalignment. The limited data potentially impacted our overall findings. The air quality datasets had different observation frequencies, with one being seasonal and the other daily. The former dataset spanned from 2008-2021 but the latter covers the timeframe from 2020-2022. Health outcomes affected by air pollutants may be misrepresented due to the lack of hospital information in areas of high pollutants. Lastly, with only 3,000 observations available from an original data set of 188,000 observations, there was a substantial reduction in sample size data.

### Future Implications
The observational patterns of air pollutant in a seasonal and daily aspect can impact urban planning and infrastructure development, environmental policy and regulation, and research opportunities. Disease and ER admissions and visits potentially impacted air quality can influence disease detection and prevention, healthcare regimen, and healthcare costs.  


