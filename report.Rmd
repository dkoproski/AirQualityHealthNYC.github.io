---
title: "Air Quality and Health in NYC"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---
```{r, echo = FALSE, message = FALSE}
library(tidyverse)
library(leaflet)
library(plotly)
library(glue)
library(leaflet.extras)
options(readr.show_col_types = FALSE)
```

# Project Report 
 
## **Introduction** 

### Background
Public health and overall community well-being are impacted by environmental factors such as the concentration of air pollutants in an area. While recent policy and public sentiment has lowered the emissions of air pollutants in many urban environments, air pollution still poses a threat to millions annually. This is especially true in urban environments with large amounts of industry and vehicle emissions. New York City is a great example of an urban setting where air pollution has been [decreasing](https://www.nyc.gov/site/doh/about/press/pr2022/earth-day-new-report-on-nyc-air-quality.page#:~:text=NYC%20Community%20Air%20Survey%20Findings%20Between%202009%20and%202020,ozone%20levels%20have%20remained%20stable.) over the past decade, but some regions still remain vulnerable. Thus, more research is required to determine where future initiatives should be targeted to best improve New York City air quality. This project aims to review the geographic and temporal distribution of air pollutants to determine if recent air pollution trends contribute to respiratory related hospitalizations and to determine which regions are experiencing the worst air pollution. 

While there are countless air pollutants, key pollutants of public health concern include: carbon monoxide (CO), ozone (O3), nitrogen dioxide (NO2), and  fine particulate matter 2.5 (PM2.5) [(WHO)](https://www.who.int/health-topics/air-pollution#tab=tab_1). As a colorless and odorless gas, CO poses a great health risk when inhaled in large amounts. Majority of CO levels are attributed to machinery that use fossil fuels such as vehicles and gas space heaters [(EPA)](https://www.epa.gov/co-pollution/basic-information-about-carbon-monoxide-co-outdoor-air-pollution). Some air pollutants, such as, ground-level ozone are created via a chemical reaction between nitrogen oxides (NO_x), volatile organic compounds (VOC), and sunlight [(EPA)](https://www.epa.gov/ground-level-ozone-pollution/ground-level-ozone-basics). During summer months O3 levels tend to peak due to regions with elevated NOX emissions. Areas with high traffic levels, NO_x reacts to ground-level O3 showing a reduction of O3 concentrations. Moreover, areas such as city centers or areas with NO_x emission show lower O3 levels [(EHDP)](https://a816-dohbesp.nyc.gov/IndicatorPublic/beta/key-topics/airquality/nyccas/). PM2.5, a prevalent air pollutant, originates from both outdoor and indoor environments. Outdoor sources comprise of vehicle emissions, gas, and fires, while indoor contributors encompass tobacco smoke, candle combustion, and oil lamps [(NYSD)](https://www.health.ny.gov/environmental/indoors/air/pmq_a.htm). 

Long term and short term exposure to the pollutants discussed above is associated with a number of health concerns such as respiratory diseases and heart attacks [(EPA)](https://www.epa.gov/report-environment/air#:~:text=Air%20pollution%2C%20whether%20indoors%20or,respiratory%20symptoms%2C%20and%20premature%20mortality.). For example, high levels of O3 can pose a great risk with those suffering from asthma [(EPA)](https://www.epa.gov/ground-level-ozone-pollution/ground-level-ozone-basics). According to the New York State Department of Heath, in-taking high levels of PM2.5 can increase the risk for health problems [(NYSD)](https://www.health.ny.gov/environmental/indoors/air/pmq_a.htm). 

### Motivation 
The need for a comprehensive analysis and sustainable solutions for the increase of air pollutants is needed. The motivation behind this project stems from the potential effects pollutants may have on human health. We aim to understand the association between air quality and public health in New York City, to identify where interventions are needed. 
?? Remove maybe keep in intro??

### Initial Questions
- What are the air quality levels in New York City?
- Which areas in New York City have more prominent air pollutants? 
- How is air quality associated to the incidence of respiratory diseases in an area?

### Related Work 
In a study evaluating the potential decrease in greenhouse gas (GHG) emissions in relation to air quality and public health in NYC, the suggested policy measures may result in an annual reduction of 160 to 390 deaths attributed to PM2.5. Neighborhoods characterized by higher poverty levels showed a more pronounced health gain [Johnson, S. 2020](https://pubs.acs.org/doi/10.1021/acs.est.0c00694). 

In a study focusing on PM2.5 levels, the potential health benefits for adults and children were assessed. Outcomes such as preterm birth, low birthweight, infant mortality, asthma incidence, hospital admissions, emergency visits, and autism spectrum disorder were considered. A estimated 23% improvement in PM2.5 was calculated, thus leasing to avoided illness cases and death. Furthermore, for the period 2021-2025, the estimated associated economic benefit ranged from \$31.8 billion and \$77 billion [Perera, F. 2021](https://www.sciencedirect.com/science/article/pii/S0013935120314523?via%3Dihub).

Ambient PM2.5 attributed deaths increased from 3.5 million in 1990 to 4.2 million in 2015. In 2015, the fifth-ranking cause of global deaths was ambient PM2.5 [PM2.5 related deaths](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5439030/). In a study following the PM2.5 concentration in NYC from 2015-2020, similar decrease levels between January and May were observed. There was less air pollutant in 2020 that could have been due to the government shutdown during the corona virus pandemic could not be confirmed[COVID shutdown](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7314691/#bb0010). 

## **Methods and Exploratory Analysis** 
### Data Sources
The initial air quality dataset was obtained from [NYC Open Data](https://data.cityofnewyork.us/Environment/Air-Quality/c3uy-2p5r), showing comprehensive  information on air pollutants in NYC from 2008 to 2021. The year range 2010 to 2021 was chosen for analysis. A subsequent air quality data set was obtained from [EPA](https://www.epa.gov/outdoor-air-quality-data/download-daily-data). 
[add info about dataset]

The initial health data set obtained from [NYC OpenData](https://data.cityofnewyork.us/Health/Emergency-Department-Visits-and-Admissions-for-Inf/2nwg-uqyg), specified emergency department visits, admissions and visits related to influenza-like and/or pneumonia illness, categorized by the modified ZIP code. A secondary disease data set from [NYC Health](https://a816-health.nyc.gov/hdi/epiquery/visualizations?PageType=ps&PopulationSource=Syndromic) detailed the number of hospitalizations attributed to asthma, diarrhea, influenza-like illness, respiratory diseases, and vomiting for each zip code. The data collection period occurred during 2016 to early 2023. 

Additionally, a geographic location dataset was used to provide more precise location data for observations in both air quality datasets. These were used in the map making process as well as for statistical analyses later. 

?? add more here i think ??


### Data Cleaning 
Two air quality and two disease data sets were obtained for analysis. [AIR QUALITY (SEASONAL) ONE CLEANING]. [AIR QUALITY (DAILY)]. 
Two disease data sets. [1] and [2]


DF for Interactive Histogram and Boxplot
```{r, message = FALSE, echo = FALSE}

# Load datasets for interactive histogram and boxplot

df_histo_pm2.5 = 
  read_csv("data/cleaned_data/uhf_airquality.csv") |> 
  filter(str_detect(time_period, "Annual Average")) |> 
  mutate(year = str_extract(time_period, "\\d{4}")) |> 
  filter(name == "Fine particles (PM 2.5)",
         year != 2009) |> 
  select(year, data_value)

df_histo_NO2 = 
  read_csv("data/cleaned_data/uhf_airquality.csv")  |> 
  filter(str_detect(time_period, "Annual Average")) |> 
  mutate(year = str_extract(time_period, "\\d{4}")) |> 
  filter(name == "Nitrogen dioxide (NO2)",
         year != 2009) |> 
  select(year, data_value) 

df_histo_ozone =
  read_csv("data/cleaned_data/uhf_airquality.csv")  |> 
  filter(name == "Ozone (O3)") |> 
  mutate(year = str_extract(time_period, "\\d{4}")) |> 
  select(year, data_value) |> 
  filter(year != 2009)
```


DF for Interactive Heatmaps
```{r, echo = FALSE, message = FALSE, warning = FALSE}

air_df = read_csv("data/cleaned_data/air_quality_zips.csv")
df_air_geo = 
  read_csv("data/cleaned_shapes/zip_shapes.csv") |> 
  select(zip, intptlat10, intptlon10) |> 
  left_join(read_csv("data/cleaned_data/air_quality_zips.csv"), by = "zip") |> 
  mutate(lat = intptlat10,
         lon = intptlon10) |> 
  select(-intptlat10, -intptlon10)
```

DF for Boxplots according to Borough
```{r message = FALSE, echo = FALSE}
daily_air = read_csv(here::here("data/cleaned_data/alt_air_data.csv")) %>%
  mutate(borough = case_when(
    county == "New York" ~ "Manhattan",
    county == "Bronx" ~ "Bronx",
    county == "Kings" ~ "Brooklyn",
    county == "Queens" ~ "Queens",
    county == "Richmond" ~ "Staten Island"
     ),
    pollutant= case_when(
    pollutant == "PM2.5" ~ "PM 2.5",
    pollutant == "Ozone" ~ "O3",
    T ~ pollutant )) %>% 
  filter(pollutant != "CO") %>%
  mutate(
    pollutant = str_c(pollutant, " (", units, ")")
  )
  
```

DF for time series by neighboorhood 
```{r}
#this data maps measurement sites to neighborhoods

sites_nghbors = read_csv(here::here("data/cleaned_data/pollutant_per_neighborhood.csv"))
```

```{r message = FALSE, echo = FALSE}
#Where Fresh Meadows is Queens and Willowbrook is in Staten Island
#Hunts Point - Mott Haven is in Bronx

#my neighborhoods on interest:

neighborhoods = c("Washington Heights", "Union Square - Lower East Side",
                  "Willowbrook", "Hunts Point - Mott Haven", "Fresh Meadows")

store_data = vector("list", length = 5)

for (i in 1:length(neighborhoods)) {
  
  n = neighborhoods[i]
  
  n_zips = sites_nghbors %>%
  filter(geo_place_name == n) %>%
  pull(zip_code)
  
  daily_data = daily_air %>%
    filter(zip_code %in% n_zips) %>%
    group_by(date, pollutant) %>%
    summarize(mean_value = mean(value),
              mean_scaled = mean(scaled_value)) %>%
    mutate(neighborhood = n)
  
  store_data[[i]] = daily_data
  
}
```

```{r}
daily_neighborhood_data = bind_rows(store_data[[1]], store_data[[2]]) %>%
  bind_rows(store_data[[3]]) %>%
  bind_rows(store_data[[4]]) %>%
  bind_rows(store_data[[5]]) %>%
  mutate(date = as.Date(date, format = "%m/%d/%Y"))
```
### Exploratory Analysis and Visualizations

O3, PM2.5, and NO2 were the air pollutants chosen for our descriptive and statistical analysis. 

#### Histogram and boxplot of air quality from 2010-2021
An interactive histogram showing each air pollutant concentration, overlaid from the years 2009-2021, was constructed to depict frequency distribution and central tendency. Additionally, the spread, central tendency, and presence of outliers were shown in an interactive box plot based on air pollutant and year. PM2.5 and NO2 concentrations continuously declined from 2009 to 2021, as evident on the layered histogram and box plots. PM2.5 showed an emphasized decrease in concentration, with the lowest median concentration exhibited in 2020.O3 concentrations initially increased from 2010 to 2016, but seemed to stabilize around 30 ppb with observed measurement decreases from 2017 to 2021. 

```{r}
all_years = sort(unique(c(as.numeric(df_histo_pm2.5$year),
                           as.numeric(df_histo_NO2$year),
                           as.numeric(df_histo_ozone$year))))

combined_fig = plot_ly()


pollutants_data = list(df_histo_pm2.5, df_histo_NO2, df_histo_ozone)
pollutant_names = c("PM2.5", "NO2", "O3")
pollutant_units = c("PM2.5 Concentration (mcg/m3)", "NO2 Concentration (ppb)", "O3 Concentration (ppb)")


for(i in seq_along(pollutants_data)) {

  for(year_value in all_years) {
    year_data = filter(pollutants_data[[i]], year == as.character(year_value))
    combined_fig = combined_fig |>
      add_histogram(data = year_data, 
                    x = ~data_value, 
                    name = as.character(year_value),
                    marker = list(opacity = 0.6),
                    visible = i == 1) 
  }
}

num_years = length(all_years)
buttons = lapply(seq_along(pollutants_data), function(i) {
  visibility = c(rep(FALSE, num_years * (i - 1)), 
                 rep(TRUE, num_years), 
                 rep(FALSE, num_years * (length(pollutants_data) - i)))
  list(method = "update",
       args = list(list("visible" = visibility),
                   list("title" = paste(pollutant_names[i], "Concentration"),
                        "xaxis.title" = pollutant_units[i])),
       label = pollutant_names[i])
})

combined_fig = combined_fig |>
  layout(title = "Comparison of Pollutant Concentrations",
         barmode = "overlay",
         xaxis = list(title = "Concentration"),
         yaxis = list(title = 'Count of Measurements'),
         updatemenus = list(list(type = "dropdown", buttons = buttons)))

combined_fig
```

```{r}
add_yearly_boxplots = function(data, years, name_prefix, visible) {
  for(year_value in years) {
    year_data = filter(data, year == as.character(year_value))
    combined_boxplot_fig <<- combined_boxplot_fig |>
      add_trace(data = year_data, 
                y = ~data_value, 
                type = 'box',
                name = paste(name_prefix, year_value),
                visible = visible)
  }
}


combined_boxplot_fig = plot_ly()


add_yearly_boxplots(df_histo_pm2.5, all_years, "PM2.5", TRUE)

add_yearly_boxplots(df_histo_NO2, all_years, "NO2", FALSE)
add_yearly_boxplots(df_histo_ozone, all_years, "O3", FALSE)


buttons = lapply(seq_along(pollutants_data), function(i) {
  visibility = c(rep(i == 1, num_years), rep(i == 2, num_years), rep(i == 3, num_years))
  list(
    method = "update",
    args = list(
      list("visible" = visibility),
      list(
        "title" = paste(pollutant_names[i], "Concentration"),
        "yaxis.title" = pollutant_units[i]
      )
    ),
    label = pollutant_names[i]
  )
})


combined_boxplot_fig = combined_boxplot_fig |>
  layout(
    title = "Comparison of Pollutant Concentrations (Boxplots)",
    yaxis = list(title = pollutant_units[1]), 
    updatemenus = list(list(type = "dropdown", buttons = buttons))
  )

combined_boxplot_fig

```

#### Heatmaps of air quality from 2010-2021
A heat map of the air pollutants with a year selector was constructed to monitor and understand the air quality in NYC. High concentrations of the selected pollutant were indicated by red and maroon, while lower concentrations were shown in green. The PM2.5 heat map showed a greater amount of PM2.5 levels in Lower Manhattan throughout the years. Comparing 2009 to 2021, the levels in each area show a decline in PM2.5 levels. Outer boroughs such as Brooklyn showed consistently high concentrations of O3 levels from 2009 to 2021. NO2 displayed a decrease in concentration however it was less noticeable. 

**2009-2021: Ozone (O3) Levels**
```{r, out.width = '100%', message = FALSE, warning = FALSE}
# Extract ozone data
o3_data = df_air_geo |> 
  filter(str_detect(name, "Ozone") & str_detect(name, "\\(")) |> 
  mutate(start_date = as.Date(start_date, format = "%m/%d/%Y"),
         year = year(start_date),
         name = str_remove(name, "(due to).*")) |> 
  select(zip, name, measure, measure_info, year, data_value, lat, lon) |> 
  group_by(zip, name, year, lat, lon) |> 
  summarize(zipmean = mean(data_value)) 

# Create yearly dataframes
yearly_data_frames <- list()
for (k in 2009:2021) {
  year_data = o3_data |> 
    filter(year == k)
  df_name = paste0("o3_", k)
  assign(df_name, year_data)
  yearly_data_frames[[as.character(k)]] = year_data
}

# Create map

palette <- c("#39FF14", "#FFFF33", "#FF7F00", "#E31A1C", "#9F0000", "#660000")
legend <- c("15-20", "20-25", "25-30", "30-35", "35-40", ">40")

m = leaflet() |> addTiles()

year_i = unique(o3_data$year)
for(year in year_i) {
  
  
  yeardata = o3_data[o3_data$year == year,]
  
  
  label_text <- glue(
    "<b>Zipcode: </b> {yeardata$zip}<br/>",
    "<b>Year: </b> {yeardata$year}<br/>",
    "<b>Zip mean: </b> {yeardata$zipmean} ppb<br/>") |> 
    lapply(htmltools::HTML)
  
  
  m = m |>
    addCircleMarkers(data = yeardata, lng = ~lon, lat = ~lat, radius = .5, opacity = 0.8, 
                     color = ~ifelse(between(zipmean, 15, 20), "#39FF14", 
                                     ifelse(between(zipmean, 20.1, 25), "#FFFF33", 
                                            ifelse(between(zipmean, 25.1, 30),"#FF7F00",
                                                   ifelse(between(zipmean, 30.1, 35), "#E31A1C",
                                                          ifelse(between(zipmean, 35.1, 40), "#9F0000", "#660000"))))),
                     label = label_text, group = as.character(year))
}

m = m |> 
  addHeatmap(data = yeardata,lng = ~lon, lat = ~lat, 
             intensity = 2, blur = 5, max = 4, radius = 10, 
             group = "Heatmap Overlay") |> 
  addLegend(labels = legend, colors = palette, title = "Ozone levels (parts per billion)") |> 
  addLayersControl(overlayGroups = "Heatmap Overlay",
                   baseGroups = year_i,
                   options = layersControlOptions(collapsed = FALSE)) 

m
```

**2008-2021: Fine Particles PM2.5**
```{r, out.width = '100%', message = FALSE, warning = FALSE}
# Extract pm2.5 data
pm25_data = df_air_geo |> 
  filter(str_detect(name, "Fine")) |> 
  mutate(start_date = as.Date(start_date, format = "%m/%d/%Y"),
         year = year(start_date),
         name = str_remove(name, "(due to).*")) |> 
  select(zip, name, measure, measure_info, year, data_value, borough, lat, lon) |> 
  group_by(zip, name, year, lat, lon) |> 
  summarize(zipmean = mean(data_value))

# Create yearly dataframes
yearly_data_frames <- list()
for (k in 2008:2021) {
  year_data = pm25_data |> 
    filter(year == k)
  df_name = paste0("pm25_", k)
  assign(df_name, year_data)
  yearly_data_frames[[as.character(k)]] = year_data
}

# Create map

palette <- c("#39FF14", "#FFFF33", "#FF7F00", "#E31A1C", "#9F0000", "#660000")
legend <- c("5-7", "7-9", "9-11", "11-13", "13-15", ">15")

m = leaflet() |> addTiles()

year_i = unique(pm25_data$year)
for(year in year_i) {
  
  
  yeardata = pm25_data[pm25_data$year == year,]
  
  
  label_text <- glue(
    "<b>Zipcode: </b> {yeardata$zip}<br/>",
    "<b>Year: </b> {yeardata$year}<br/>",
    "<b>Zip mean: </b> {round(yeardata$zipmean,3)} mcg/m3<br/>") |> 
    lapply(htmltools::HTML)
  
  
  m = m |>
    addCircleMarkers(data = yeardata, lng = ~lon, lat = ~lat, radius = .5, opacity = 0.8, 
                     color = ~ifelse(between(zipmean, 5, 7), "#39FF14", 
                                     ifelse(between(zipmean, 7.1, 9), "#FFFF33", 
                                            ifelse(between(zipmean, 9.1, 11),"#FF7F00",
                                                   ifelse(between(zipmean, 11.1, 13), "#E31A1C",
                                                          ifelse(between(zipmean, 13.1, 15), "#9F0000", "#660000"))))),
                     label = label_text, group = as.character(year))
}

m = m |> 
  addHeatmap(data = yeardata,lng = ~lon, lat = ~lat, 
             intensity = 2, blur = 5, max = 4, radius = 10, 
             group = "Heatmap Overlay") |> 
  addLegend(labels = legend, colors = palette, title = "PM2.5 levels (mcg/m3)") |> 
  addLayersControl(overlayGroups = "Heatmap Overlay",
                   baseGroups = year_i,
                   options = layersControlOptions(collapsed = FALSE)) 

m
```

**2008-2021: Nitrogen dioxide (NO2)**
```{r, out.width = '100%', message = FALSE, warning = FALSE}
# Extract NO2 data
no2_data = df_air_geo |> 
  filter(str_detect(name, "Nitrogen")) |> 
  mutate(start_date = as.Date(start_date, format = "%m/%d/%Y"),
         year = year(start_date),
         name = str_remove(name, "(due to).*")) |> 
  select(zip, name, measure, measure_info, year, data_value, borough, lat, lon) |> 
  group_by(zip, name, year, lat, lon) |> 
  summarize(zipmean = mean(data_value))

# Create yearly dataframes
yearly_data_frames <- list()
for (k in 2008:2021) {
  year_data = no2_data |> 
    filter(year == k)
  df_name = paste0("no2_", k)
  assign(df_name, year_data)
  yearly_data_frames[[as.character(k)]] = year_data
}

# Create map

palette <- c("#39FF14", "#FFFF33", "#FF7F00", "#E31A1C", "#9F0000", "#660000")
legend <- c("8-15", "15-22", "22-29", "29-36", "36-43", "43-50")

m = leaflet() |> addTiles()

year_i = unique(no2_data$year)
for(year in year_i) {
  
  
  yeardata = no2_data[no2_data$year == year,]
  
  
  label_text <- glue(
    "<b>Zipcode: </b> {yeardata$zip}<br/>",
    "<b>Year: </b> {yeardata$year}<br/>",
    "<b>Zip mean: </b> {round(yeardata$zipmean,3)} ppb<br/>") |> 
    lapply(htmltools::HTML)
  
  
  m = m |>
    addCircleMarkers(data = yeardata, lng = ~lon, lat = ~lat, radius = .5, opacity = 0.8, 
                     color = ~ifelse(between(zipmean, 8, 15), "#39FF14", 
                                     ifelse(between(zipmean, 15.1, 22), "#FFFF33", 
                                            ifelse(between(zipmean, 22.1, 29),"#FF7F00",
                                                   ifelse(between(zipmean, 29.1, 36), "#E31A1C",
                                                          ifelse(between(zipmean, 36.1, 43), "#9F0000", "#660000"))))),
                     label = label_text, group = as.character(year))
}

m = m |> 
  addHeatmap(data = yeardata,lng = ~lon, lat = ~lat, 
             intensity = 2, blur = 5, max = 4, radius = 10, 
             group = "Heatmap Overlay") |> 
  addLegend(labels = legend, colors = palette, title = "NO2 levels (parts per billion)") |> 
  addLayersControl(overlayGroups = "Heatmap Overlay",
                   baseGroups = year_i,
                   options = layersControlOptions(collapsed = FALSE)) 

m
```


#### Time series plots on daily counts of air pollutants and daily disease visits
Time series plots were created for daily air concentrations. Trend and seasonal patterns of CO, O3, and N02 showed oscillations throughout the year. Specifically, O3 showed the a greater difference and reached high levels during the summer month a opposed to NO2 which peaked in the winter. PM2.4 should a steady concentration trend and did not display seasonal patterns. Similarly, time series plot in regards to daily ER visit and disease counts were generated, showing that asthma and respiratory diseases did not have a seasonal pattern. However, pneumonia ER visits did peak during the winter months. 

```{r, out.width = '100%', message = F}
air_qual_df = read_csv("data/cleaned_data/alt_air_data.csv") |> 
  separate(date, into=c("month", "day", "year")) |>
  mutate(day = as.numeric(day),
         month = month.name[as.numeric(month)],
         year = as.numeric(year)) |> 
  filter(!(year == '2020' & month == 'January'),
         !(year == '2020' & month == 'February')) |> 
  rename(zip = zip_code) |> 
  select(year, month, day, zip, pollutant, value) |> 
  group_by(day, month, year, zip, pollutant) |> 
  summarize(value = mean(value))

poll_plot = air_qual_df |> 
  mutate(
    numeric_month = match(month, month.name),
    date = as.Date(paste(year, numeric_month, day, sep = "-"), 
                   format = "%Y-%m-%d"),
    pollutant = case_when(
      pollutant =="CO" ~ "Carbon Monoxide (ppm)",
      pollutant =="PM2.5" ~ "PM2.5 (μg/m3)",
      pollutant =="Ozone" ~ "Ozone (ppm)",
      pollutant =="NO2" ~ "Nitrogen Dioxide (ppb)"),
    across(pollutant, ~factor(., levels=c("Carbon Monoxide (ppm)",
                                          "Ozone (ppm)",
                                          "Nitrogen Dioxide (ppb)",
                                          "PM2.5 (μg/m3)"))),) |> 
  ggplot(aes(x = date, y = value, color = pollutant)) +
  geom_point() +
  geom_smooth(color = "blue") +
  facet_wrap(~ pollutant, ncol = 2, scales="free_y") +
  ggtitle("Daily average of each pollutant by zip code") + 
  scale_color_discrete()

poll_plot
```

```{r, out.width = '100%', message = F, warning = F}
all_dis_plot_df = read_csv("data/cleaned_data/disease_only.csv") |>
  mutate(
    numeric_month = match(month, month.name),
    date = as.Date(paste(year, numeric_month, day, sep = "-"), format = "%Y-%m-%d")
  ) |> 
  select(-day, -month, -year, -numeric_month, -total_ed_visits) |> 
  pivot_longer(cols = c("count_resp", "count_asth", "ili_pne_visits", "ili_pne_admissions"), 
               names_to = "variable",
               values_to = "count")

dis_plot = all_dis_plot_df |> 
  
  mutate(variable = case_when(
      variable =="count_resp" ~ "Respiratory diseases",
      variable =="count_asth" ~ "Asthma",
      variable =="ili_pne_visits" ~ "Pneumonia (ER visits)",
      variable =="ili_pne_admissions" ~ "Pneumonia (admissions)"),
      across(variable, ~factor(., levels=c("Asthma","Respiratory diseases",
                                           "Pneumonia (ER visits)",
                                           "Pneumonia (admissions)"))))|> 
  ggplot(aes(x = date, y = count, color = variable)) +
  geom_point() +
  geom_smooth(color = "blue") +
  facet_wrap(~ variable, ncol = 2, scales="free_y") +
  ggtitle("Daily counts of disease variables by zip") + 
  scale_color_discrete()

dis_plot
```

#### Boxplots of daily air pollutants by borough
The frequency distribution of daily air pollutant concentrations in regard to borough was shown in boxplots. NO2 and PM2.5 showed consistent daily medians throughout each borough. O3 showed a slightly elevated daily concentration median in Staten Island compared to other boroughs. 

```{r}
daily_air %>%
  ggplot() + geom_boxplot(aes(x = borough, y = value, fill = borough)) + 
  labs(x = "Borough", y = "Measurement value", fill = "Borough") +
  theme(axis.text.x  = element_text(angle=15)) +
  facet_wrap(~pollutant, scales = 'free')
```

#### Time series plots on daily air pollutants by neighborhood 
In the context of these time series plots, the daily mean measurement of each pollutant, categorized by neighborhoods, was derived and depicted as a distinctive line. Coherent patterns were observed for each pollutant in these neighborhoods. NO2 displayed its pinnacle reach during the winter and spring transitions, where as O3 sowed its highest vales in the summer months. These visual representation shows and highlights the nuanced temporal fluctuation between the pollutants. 

```{r}
daily_neighborhood_data %>%
  filter(pollutant == "NO2 (ppb)") %>%
  ggplot() + geom_line(aes(x = date, y = mean_value,
                            group = neighborhood, color = neighborhood)) +
  scale_color_manual(values = c("red", "blue", 
                                    "green","orange", 
                                    "black")) +
  labs(title = "NO2 measurements per neighborhood", x = "Date", 
       y = "Mean measurement (ppb)", color = "Neighborhood")
```


```{r}
daily_neighborhood_data %>%
  filter(pollutant == "O3 (ppm)") %>%
  ggplot() + geom_line(aes(x = date, y = mean_value,
                            group = neighborhood, color = neighborhood)) +
  scale_color_manual(values = c("red", "blue", 
                                    "green","orange", 
                                    "black")) +
  labs(title = "O3 measurements per neighborhood", x = "Date", 
       y = "Mean measurement (ppm)", color = "Neighborhood")
```

```{r}
daily_neighborhood_data %>%
  filter(pollutant == "PM 2.5 (ug/m3 LC)") %>%
  ggplot() + geom_line(aes(x = date, y = mean_value,
                            group = neighborhood, color = neighborhood)) +
  scale_color_manual(values = c("red", "blue", 
                                    "black",
                                    "green","orange")) +
  labs(title = "PM 2.5 measurements per neighborhood", x = "Date", 
       y = "Mean measurement (ug/m3 LC)", color = "Neighborhood")
```

#### EDA DAILY DISEASE VISITS


## **Statistical Results** 
Cross correlation analysis was used to examine the relationship between O3 and pneumonia ER visits. From the cross-correlation plots, the positive and negative correlations determined the lag between O3 levels and and pneumonia ER visits was about 117 days. The lag was added as an additional predictor in the linear regression model. There was a negative correlation in pneumonia ER visits and O3 regression model before the lag was added. However, after adding the lag, a positive correlation emerged between pneumonia ER visits and O3. 



## **Discussion and Conclusions**
### Findings


- Are they what you expect? 
- What insights into the data can you make?


### Limitations

Several challenges arose in the analysis related to data processing. The datasets had significant constraints, including limited data, temporal dimensions, and location misalignment. The limited data potentially impacted our overall findings. The air quality datasets had different observation frequencies, with one being seasonal and the other daily. Health outcomes affected by air pollutants  may be misrepresented due to the lack of hospital information in areas of high pollutants. Lastly, with only 3,000 observations available from an original data set of 188,000 observations, there was a substantial reduction in sample size data.

### Future Implications




