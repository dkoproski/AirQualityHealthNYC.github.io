<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Data Processing</title>

<script src="site_libs/header-attrs-2.24/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.13.2/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/navigation-1.1/codefolding.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>









<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark the anchor link active (and if it's in a dropdown, also mark that active)
  var dropdown = menuAnchor.closest('li.dropdown');
  if (window.bootstrap) { // Bootstrap 4+
    menuAnchor.addClass('active');
    dropdown.find('> .dropdown-toggle').addClass('active');
  } else { // Bootstrap 3
    menuAnchor.parent().addClass('active');
    dropdown.addClass('active');
  }

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Home</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="data.html">Data Sources</a>
</li>
<li>
  <a href="data_processing.html">Data Processing</a>
</li>
<li>
  <a href="eda.html">Exploratory Analysis</a>
</li>
<li>
  <a href="viz.html">Interactive Maps</a>
</li>
<li>
  <a href="stats.html">Statistical Analysis</a>
</li>
<li>
  <a href="report.html">Final Report</a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">

<div class="btn-group pull-right float-right">
<button type="button" class="btn btn-default btn-xs btn-secondary btn-sm dropdown-toggle" data-toggle="dropdown" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu dropdown-menu-right" style="min-width: 50px;">
<li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
<li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
</ul>
</div>



<h1 class="title toc-ignore">Data Processing</h1>

</div>


<div id="merging-joined_respiratory.csv-and-air_quality_disease.csv"
class="section level1">
<h1>Merging <code>joined_respiratory.csv</code> and
<code>air_quality_disease.csv</code></h1>
<pre class="r"><code># Load dataset with respiratory and asthma counts (missing some zipcodes)

dis_asth_df = read_csv(&quot;data/cleaned_data/joined_respiratory.csv&quot;) |&gt; 
  filter(zip != 88888 &amp; zip != &quot;Citwide&quot; &amp; age_group == &quot;All age groups&quot;) |&gt; 
  mutate(date = as.Date(format(as.Date(date, &quot;%m/%d/%y&quot;))),
         year = as.numeric(format(date, format = &quot;%Y&quot;)),
         month = month.name[as.numeric(format(date, format = &quot;%m&quot;))],
         day = as.numeric(format(date, format = &quot;%d&quot;)),
         zip = as.numeric(zip)) |&gt;
  select(year, month, day, zip, count_resp, count_asth) 

# Load dataset with pneumonia data

dis_pneu_df = read_csv(&quot;data/raw_data/disease_hospital_admin.csv&quot;) |&gt; 
  separate(date, into=c(&quot;month&quot;, &quot;day&quot;, &quot;year&quot;)) |&gt; 
  mutate(day = as.numeric(day),
         month = month.name[as.numeric(month)],
         year = as.numeric(year)) |&gt; 
  rename(zip = mod_zcta) |&gt; 
  select(year, month, day, zip, total_ed_visits, ili_pne_visits, ili_pne_admissions)

# Merge two disease datasets

all_dis_df =
  full_join(dis_asth_df, dis_pneu_df, by = c(&quot;month&quot;, &quot;day&quot;, &quot;year&quot;, &quot;zip&quot;))

# Now merge disease with air quality dataset

air_qual_df = read_csv(&quot;data/cleaned_data/alt_air_data.csv&quot;) |&gt; 
  separate(date, into=c(&quot;month&quot;, &quot;day&quot;, &quot;year&quot;)) |&gt;
  mutate(day = as.numeric(day),
         month = month.name[as.numeric(month)],
         year = as.numeric(year)) |&gt; 
  filter(!(year == &#39;2020&#39; &amp; month == &#39;January&#39;),
         !(year == &#39;2020&#39; &amp; month == &#39;February&#39;),
         !(aqs_parameter_desc == &quot;Acceptable PM2.5 AQI &amp; Speciation Mass&quot;)) |&gt;
  rename(zip = zip_code) |&gt; 
  select(year, month, day, zip, daily_aqi_value, pollutant, value) |&gt; 
  group_by(day, month, year, zip, pollutant) |&gt; 
  summarize(value = mean(value))

# air_qual_df_aqi = read_csv(&quot;data/cleaned_data/alt_air_data.csv&quot;) |&gt; 
#   separate(date, into=c(&quot;month&quot;, &quot;day&quot;, &quot;year&quot;)) |&gt;
#   mutate(day = as.numeric(day),
#          month = month.name[as.numeric(month)],
#          year = as.numeric(year)) |&gt; 
#   filter(!(year == &#39;2020&#39; &amp; month == &#39;January&#39;),
#          !(year == &#39;2020&#39; &amp; month == &#39;February&#39;),
#          !(aqs_parameter_desc == &quot;Acceptable PM2.5 AQI &amp; Speciation Mass&quot;)) |&gt;  
#   rename(zip = zip_code) |&gt; 
#   select(year, month, day, zip, daily_aqi_value, pollutant, value) |&gt; 
#   group_by(day, month, year, zip, pollutant) |&gt; 
#   summarize(daily_aqi = mean(daily_aqi_value))

### note: removed acceptable pm2.5... from https://www.epa.gov/aqs/aqs-memos-technical-note-reporting-pm25-continuous-monitoring-and-speciation-data-air-quality

# Finally merge disease and air qual data together

air_qual_dis = # with value
  full_join(all_dis_df, air_qual_df, by = c(&quot;month&quot;, &quot;day&quot;, &quot;year&quot;, &quot;zip&quot;)) |&gt;  
  mutate(
    numeric_month = match(month, month.name),
    date = as.Date(paste(year, numeric_month, day, sep = &quot;-&quot;), format = &quot;%Y-%m-%d&quot;)
  ) |&gt; 
  select(year, month, day, date, zip, count_resp, count_asth, total_ed_visits, 
         ili_pne_visits, ili_pne_admissions, pollutant, value) |&gt; 
  pivot_wider(names_from = pollutant,
              values_from = value) |&gt; 
  select(-`NA`) |&gt; 
  rename(pm25_ug_m3_lc = PM2.5,
         co_ppm = CO,
         o3_ppm = Ozone,
         no2_ppb = NO2) |&gt; 
  filter(!(year == &#39;2022&#39; &amp; month == &#39;December&#39;)) 


  
# air_qual_dis_aqi = # with daily aqi value
#   full_join(all_dis_df, air_qual_df_aqi, by = c(&quot;month&quot;, &quot;day&quot;, &quot;year&quot;, &quot;zip&quot;)) |&gt; 
#   select(year, month, day, zip, count_resp, count_asth, total_ed_visits, 
#          ili_pne_visits, ili_pne_admissions, pollutant, daily_aqi) |&gt; 
#   pivot_wider(names_from = pollutant,
#               values_from = daily_aqi) |&gt; 
#   select(-`NA`) |&gt; 
#   rename(pm25_ug_m3_lc = PM2.5,
#          co_ppm = CO,
#          o3_ppm = Ozone,
#          no2_ppb = NO2) |&gt; 
#   filter(!(year == &#39;2022&#39; &amp; month == &#39;December&#39;)) |&gt; 
#   mutate(
#     numeric_month = match(month, month.name),
#     date = as.Date(paste(year, numeric_month, day, sep = &quot;-&quot;), format = &quot;%Y-%m-%d&quot;)
#   )

# measurement: ozone (daily_max_8_hour_ozone_concentration)
# co (daily_max_8_hour_co_concentration)
# pm2.5 (daily_mean_pm2_5_concentration)
# no2 (daily_max_1_hour_no2_concentration)</code></pre>
</div>
<div id="compare-two-air-quality-datasets-daily-vs.-seasonalannual"
class="section level1">
<h1>Compare two air quality datasets (daily vs. seasonal/annual)</h1>
<pre class="r"><code>airqual_annual = read_csv(&quot;data/cleaned_data/uhf_airquality.csv&quot;) |&gt; 
  filter(str_detect(name, &quot;Fine&quot;) | str_detect(name, &quot;NO2&quot;) | str_detect(name, &quot;O3&quot;)) 

airqual_annual = read_csv(&quot;data/cleaned_data/uhf_airquality.csv&quot;) |&gt; 
  filter(str_detect(name, &quot;Fine&quot;)) 
table(airqual_annual$time_period)

#### Prepare dataset from daily data (Summer: 1June-31Aug, Winter 1Dec-28Feb)

# Annual averages for each pollutant and each zip

airqual_yr_avg = air_qual_df |&gt; 
  group_by(year, zip, pollutant) |&gt; 
  summarize(mean = mean(value)) |&gt; 
  pivot_wider(
    names_from = pollutant,
    values_from = mean
  )

# Seasonal averages for each pollutant and each zip

airqual_szn_avg = air_qual_df |&gt; 
  mutate(season = case_when(
    month %in% c(&quot;June&quot;, &quot;July&quot;, &quot;August&quot;) ~ &quot;summer&quot;,
    month %in% c(&quot;December&quot;, &quot;January&quot;, &quot;February&quot;) ~ &quot;winter&quot;,
    TRUE ~ &quot;other&quot;
  )) |&gt; 
  filter(season != &quot;other&quot;) |&gt; 
  group_by(season, year, zip, pollutant) |&gt; 
  summarize(mean = mean(value)) |&gt; 
  pivot_wider(
    names_from = pollutant,
    values_from = mean
  )

#### Prepare dataset from daily data

airqual_annual = read_csv(&quot;data/cleaned_data/uhf_airquality.csv&quot;) |&gt; 
  filter(str_detect(name, &quot;Fine&quot;) | str_detect(name, &quot;NO2&quot;) | str_detect(name, &quot;O3&quot;)) |&gt; 
  select(name, )

#### Comparison between daily data and yearly/seasonal data</code></pre>
</div>
<div id="exploratory-data-analysis" class="section level1">
<h1>Exploratory Data Analysis</h1>
<div id="how-do-disease-variables-change-over-time"
class="section level2">
<h2>How do disease variables change over time?</h2>
<p>Let us first visualize how the number of emergency department visits
change over time. We can see that daily ER visits seem to peak in winter
months except in 2021. This could be due to COVID restrictions.</p>
<pre class="r"><code>all_dis_plot_df = all_dis_df |&gt;
  mutate(
    numeric_month = match(month, month.name),
    date = as.Date(paste(year, numeric_month, day, sep = &quot;-&quot;), format = &quot;%Y-%m-%d&quot;)
  ) |&gt; 
  select(-day, -month, -year, -numeric_month) |&gt; 
  pivot_longer(cols = c(&quot;count_resp&quot;, &quot;count_asth&quot;, &quot;total_ed_visits&quot;, &quot;ili_pne_visits&quot;, &quot;ili_pne_admissions&quot;), 
               names_to = &quot;variable&quot;,
               values_to = &quot;count&quot;) 

er_plot = all_dis_plot_df |&gt; 
  filter(variable == &quot;total_ed_visits&quot;) |&gt; 
  plot_ly(x = ~date, y = ~count, 
          type = &#39;scatter&#39;, 
          mode = &#39;markers&#39;, 
          text = ~paste(&quot;Zip: &quot;, zip, &quot;&lt;br&gt;Date:&quot;, date, &quot;&lt;br&gt;Count:&quot;, count),
          color = &quot;viridis&quot;) |&gt; 
  layout(title = &#39;Daily total ER visits by zip&#39;, plot_bgcolor = &quot;#e5ecf6&quot;, 
         xaxis = list(title = &quot;Date&quot;), 
         yaxis = list(title = &quot;Counts&quot;))

er_plot</code></pre>
<pre class="r"><code>all_dis_df |&gt;
  mutate(
    numeric_month = match(month, month.name),
    date = as.Date(paste(year, numeric_month, day, sep = &quot;-&quot;), format = &quot;%Y-%m-%d&quot;)
  ) |&gt; 
  ggplot(aes(x = date, y = total_ed_visits)) +
  geom_point() +
  labs(title = &quot;Daily total ER visits by zip&quot;,
       y = &quot;Total ER visits&quot;) +
  theme(legend.position = &quot;none&quot;)</code></pre>
<p><img src="data_processing_files/figure-html/unnamed-chunk-4-1.png" width="100%" /></p>
<p>From the plot below, we can see that the number of emergency
department visits related to pneumonia peak during winter seasons.</p>
<pre class="r"><code>resp_plot = all_dis_plot_df |&gt; 
  filter(variable == &quot;count_resp&quot;) |&gt; 
  plot_ly(x = ~date, y = ~count, 
          type = &#39;scatter&#39;, 
          mode = &#39;markers&#39;, 
          text = ~paste(&quot;Zip: &quot;, zip, &quot;&lt;br&gt;Date:&quot;, date, &quot;&lt;br&gt;Count:&quot;, count),
          marker = list(color = &quot;#35B779&quot;))

asth_plot = all_dis_plot_df |&gt; 
  filter(variable == &quot;count_asth&quot;) |&gt; 
  plot_ly(x = ~date, y = ~count, 
          type = &#39;scatter&#39;, 
          mode = &#39;markers&#39;, 
          text = ~paste(&quot;Zip: &quot;, zip, &quot;&lt;br&gt;Date:&quot;, date, &quot;&lt;br&gt;Count:&quot;, count),
          marker = list(color = &quot;#B8860B&quot;))

pne_visit_plot = all_dis_plot_df |&gt; 
  filter(variable == &quot;ili_pne_visits&quot;) |&gt; 
  plot_ly(x = ~date, y = ~count, 
          type = &#39;scatter&#39;, 
          mode = &#39;markers&#39;, 
          text = ~paste(&quot;Zip: &quot;, zip, &quot;&lt;br&gt;Date:&quot;, date, &quot;&lt;br&gt;Count:&quot;, count),
          marker = list(color = &quot;#440154&quot;))

pne_adm_plot = all_dis_plot_df |&gt; 
  filter(variable == &quot;ili_pne_admissions&quot;) |&gt; 
  plot_ly(x = ~date, y = ~count, 
          type = &#39;scatter&#39;, 
          mode = &#39;markers&#39;, 
          text = ~paste(&quot;Zip: &quot;, zip, &quot;&lt;br&gt;Date:&quot;, date, &quot;&lt;br&gt;Count:&quot;, count),
          marker = list(color = &quot;#31688E&quot;))

fig = subplot(resp_plot, asth_plot, pne_visit_plot, pne_adm_plot, 
              nrows = 2, shareX = TRUE) |&gt; 
  layout(plot_bgcolor=&#39;#e5ecf6&#39;, 
         title = &#39;Daily counts of variables by zip&#39;,
         xaxis = list(title = &quot;date&quot;), 
         showlegend = FALSE) 

annotations = list( 
  list(
    x = 0.25, y = 0.9, 
    text = &quot;Respiratory diseases&quot;, 
    xref = &quot;paper&quot;, yref = &quot;paper&quot;, 
    xanchor = &quot;center&quot;, yanchor = &quot;bottom&quot;, 
    showarrow = FALSE),  
  list( 
    x = 0.75, y = 0.9, 
    text = &quot;Asthma&quot;,  
    xref = &quot;paper&quot;, yref = &quot;paper&quot;,  
    xanchor = &quot;center&quot;, yanchor = &quot;bottom&quot;, 
    showarrow = FALSE 
  ),  
  list( 
    x = 0.25, y = 0.4, text = &quot;Pneumonia (ER visits)&quot;,  
    xref = &quot;paper&quot;, yref = &quot;paper&quot;,  
    xanchor = &quot;center&quot;, yanchor = &quot;bottom&quot;,  
    showarrow = FALSE 
  ),
  list( 
    x = 0.75, y = 0.4,  
    text = &quot;Pneumonia (admissions)&quot;,  
    xref = &quot;paper&quot;, yref = &quot;paper&quot;,  
    xanchor = &quot;center&quot;, yanchor = &quot;bottom&quot;,  
    showarrow = FALSE 
  ))


fig = fig |&gt; layout(annotations = annotations) 
fig</code></pre>
<pre class="r"><code>all_dis_plot_df = all_dis_df |&gt;
  mutate(
    numeric_month = match(month, month.name),
    date = as.Date(paste(year, numeric_month, day, sep = &quot;-&quot;), format = &quot;%Y-%m-%d&quot;)
  ) |&gt; 
  select(-day, -month, -year, -numeric_month) |&gt; 
  pivot_longer(cols = c(&quot;count_resp&quot;, &quot;count_asth&quot;, &quot;total_ed_visits&quot;, &quot;ili_pne_visits&quot;, &quot;ili_pne_admissions&quot;), 
               names_to = &quot;variable&quot;,
               values_to = &quot;count&quot;) 

dis_plot = all_dis_plot_df |&gt; 
  filter(variable != &quot;total_ed_visits&quot;) |&gt; 
  mutate(variable = case_when(
      variable ==&quot;count_resp&quot; ~ &quot;Respiratory diseases&quot;,
      variable ==&quot;count_asth&quot; ~ &quot;Asthma&quot;,
      variable ==&quot;ili_pne_visits&quot; ~ &quot;Pneumonia (ER visits)&quot;,
      variable ==&quot;ili_pne_admissions&quot; ~ &quot;Pneumonia (admissions)&quot;),
      across(variable, ~factor(., levels=c(&quot;Asthma&quot;,&quot;Respiratory diseases&quot;,
                                           &quot;Pneumonia (ER visits)&quot;,
                                           &quot;Pneumonia (admissions)&quot;))))|&gt; 
  ggplot(aes(x = date, y = count, color = variable)) +
  geom_point() +
  geom_smooth(color = &quot;blue&quot;) +
  facet_wrap(~ variable, ncol = 2, scales=&quot;free_y&quot;) +
  ggtitle(&quot;Daily counts of disease variables by zip&quot;) + 
  scale_color_discrete()

dis_plot</code></pre>
<p><img src="data_processing_files/figure-html/unnamed-chunk-6-1.png" width="100%" /></p>
</div>
<div id="how-do-pollutant-variables-change-over-time"
class="section level2">
<h2>How do pollutant variables change over time?</h2>
<pre class="r"><code>poll_plot = air_qual_df |&gt; 
  mutate(
    numeric_month = match(month, month.name),
    date = as.Date(paste(year, numeric_month, day, sep = &quot;-&quot;), 
                   format = &quot;%Y-%m-%d&quot;),
    pollutant = case_when(
      pollutant ==&quot;CO&quot; ~ &quot;Carbon Monoxide (ppm)&quot;,
      pollutant ==&quot;PM2.5&quot; ~ &quot;PM2.5 (μg/m3)&quot;,
      pollutant ==&quot;Ozone&quot; ~ &quot;Ozone (ppm)&quot;,
      pollutant ==&quot;NO2&quot; ~ &quot;Nitrogen Dioxide (ppb)&quot;),
    across(pollutant, ~factor(., levels=c(&quot;Carbon Monoxide (ppm)&quot;,
                                          &quot;Ozone (ppm)&quot;,
                                          &quot;Nitrogen Dioxide (ppb)&quot;,
                                          &quot;PM2.5 (μg/m3)&quot;))),) |&gt; 
  ggplot(aes(x = date, y = value, color = pollutant)) +
  geom_point() +
  geom_smooth(color = &quot;blue&quot;) +
  facet_wrap(~ pollutant, ncol = 2, scales=&quot;free_y&quot;) +
  ggtitle(&quot;Daily average of each pollutant by zip&quot;) + 
  scale_color_discrete()

poll_plot</code></pre>
<p><img src="data_processing_files/figure-html/unnamed-chunk-7-1.png" width="100%" /></p>
</div>
</div>
<div id="cross-correlation-analysis" class="section level1">
<h1>Cross correlation analysis</h1>
<pre class="r"><code>ccf_df = air_qual_dis |&gt; 
  filter(!is.na(o3_ppm) &amp; !is.na(ili_pne_visits)) |&gt; 
  mutate(date_lag = date + days(117),
         scaled_o3 = o3_ppm * 100, 
         lagged_o3 = lag(scaled_o3, n = 117)
  )
print(ccf(ccf_df$o3_ppm, ccf_df$ili_pne_admissions, lag.max=250))</code></pre>
<p><img src="data_processing_files/figure-html/unnamed-chunk-8-1.png" width="672" /></p>
<pre><code>## 
## Autocorrelations of series &#39;X&#39;, by lag
## 
##   -250   -249   -248   -247   -246   -245   -244   -243   -242   -241   -240 
## -0.014  0.014  0.014  0.023  0.023  0.019  0.020  0.018  0.014  0.025  0.023 
##   -239   -238   -237   -236   -235   -234   -233   -232   -231   -230   -229 
##  0.040  0.037  0.043  0.018  0.026  0.031  0.039  0.049  0.032  0.043  0.055 
##   -228   -227   -226   -225   -224   -223   -222   -221   -220   -219   -218 
##  0.047  0.046  0.035  0.046  0.056  0.051  0.067  0.063  0.060  0.063  0.077 
##   -217   -216   -215   -214   -213   -212   -211   -210   -209   -208   -207 
##  0.087  0.081  0.076  0.077  0.078  0.071  0.085  0.095  0.109  0.096  0.108 
##   -206   -205   -204   -203   -202   -201   -200   -199   -198   -197   -196 
##  0.110  0.112  0.111  0.107  0.095  0.090  0.097  0.084  0.105  0.102  0.100 
##   -195   -194   -193   -192   -191   -190   -189   -188   -187   -186   -185 
##  0.115  0.124  0.122  0.121  0.117  0.125  0.131  0.134  0.147  0.131  0.142 
##   -184   -183   -182   -181   -180   -179   -178   -177   -176   -175   -174 
##  0.127  0.127  0.124  0.139  0.148  0.132  0.140  0.141  0.145  0.147  0.145 
##   -173   -172   -171   -170   -169   -168   -167   -166   -165   -164   -163 
##  0.156  0.158  0.159  0.162  0.153  0.143  0.155  0.155  0.159  0.155  0.160 
##   -162   -161   -160   -159   -158   -157   -156   -155   -154   -153   -152 
##  0.159  0.163  0.159  0.157  0.157  0.167  0.166  0.163  0.166  0.152  0.145 
##   -151   -150   -149   -148   -147   -146   -145   -144   -143   -142   -141 
##  0.147  0.150  0.156  0.162  0.158  0.159  0.148  0.152  0.141  0.138  0.147 
##   -140   -139   -138   -137   -136   -135   -134   -133   -132   -131   -130 
##  0.136  0.136  0.148  0.150  0.141  0.147  0.132  0.116  0.118  0.118  0.109 
##   -129   -128   -127   -126   -125   -124   -123   -122   -121   -120   -119 
##  0.105  0.103  0.097  0.107  0.106  0.086  0.079  0.075  0.082  0.070  0.066 
##   -118   -117   -116   -115   -114   -113   -112   -111   -110   -109   -108 
##  0.065  0.068  0.072  0.059  0.056  0.052  0.040  0.045  0.029  0.024  0.026 
##   -107   -106   -105   -104   -103   -102   -101   -100    -99    -98    -97 
##  0.037  0.047  0.028  0.012  0.009  0.005  0.004 -0.005 -0.012  0.006 -0.015 
##    -96    -95    -94    -93    -92    -91    -90    -89    -88    -87    -86 
## -0.032 -0.026 -0.040 -0.036 -0.041 -0.040 -0.045 -0.045 -0.051 -0.052 -0.049 
##    -85    -84    -83    -82    -81    -80    -79    -78    -77    -76    -75 
## -0.061 -0.069 -0.079 -0.056 -0.068 -0.076 -0.081 -0.081 -0.077 -0.077 -0.080 
##    -74    -73    -72    -71    -70    -69    -68    -67    -66    -65    -64 
## -0.085 -0.084 -0.093 -0.091 -0.082 -0.108 -0.104 -0.105 -0.117 -0.113 -0.112 
##    -63    -62    -61    -60    -59    -58    -57    -56    -55    -54    -53 
## -0.129 -0.130 -0.124 -0.107 -0.096 -0.123 -0.141 -0.141 -0.126 -0.125 -0.134 
##    -52    -51    -50    -49    -48    -47    -46    -45    -44    -43    -42 
## -0.127 -0.133 -0.120 -0.123 -0.129 -0.132 -0.136 -0.138 -0.131 -0.142 -0.138 
##    -41    -40    -39    -38    -37    -36    -35    -34    -33    -32    -31 
## -0.127 -0.123 -0.125 -0.146 -0.138 -0.133 -0.125 -0.132 -0.133 -0.136 -0.125 
##    -30    -29    -28    -27    -26    -25    -24    -23    -22    -21    -20 
## -0.110 -0.106 -0.103 -0.105 -0.123 -0.104 -0.092 -0.086 -0.096 -0.087 -0.087 
##    -19    -18    -17    -16    -15    -14    -13    -12    -11    -10     -9 
## -0.096 -0.097 -0.097 -0.070 -0.087 -0.095 -0.087 -0.076 -0.069 -0.081 -0.086 
##     -8     -7     -6     -5     -4     -3     -2     -1      0      1      2 
## -0.074 -0.060 -0.059 -0.054 -0.056 -0.050 -0.046 -0.047 -0.052 -0.037 -0.029 
##      3      4      5      6      7      8      9     10     11     12     13 
## -0.032 -0.049 -0.040 -0.032 -0.027 -0.020 -0.022 -0.031 -0.020 -0.015 -0.002 
##     14     15     16     17     18     19     20     21     22     23     24 
##  0.007  0.002  0.009 -0.016 -0.002  0.003  0.011 -0.013 -0.010 -0.009 -0.003 
##     25     26     27     28     29     30     31     32     33     34     35 
##  0.007  0.019  0.012 -0.006  0.012  0.032  0.024  0.027  0.012  0.008  0.010 
##     36     37     38     39     40     41     42     43     44     45     46 
##  0.021  0.038  0.030  0.026  0.017  0.023  0.019  0.020  0.030  0.031  0.024 
##     47     48     49     50     51     52     53     54     55     56     57 
##  0.025  0.015  0.025  0.033  0.033  0.034  0.046  0.029  0.025  0.033  0.039 
##     58     59     60     61     62     63     64     65     66     67     68 
##  0.040  0.055  0.041  0.034  0.039  0.055  0.055  0.047  0.063  0.076  0.067 
##     69     70     71     72     73     74     75     76     77     78     79 
##  0.090  0.079  0.077  0.093  0.107  0.099  0.114  0.099  0.092  0.100  0.106 
##     80     81     82     83     84     85     86     87     88     89     90 
##  0.099  0.089  0.083  0.089  0.096  0.093  0.095  0.112  0.116  0.111  0.117 
##     91     92     93     94     95     96     97     98     99    100    101 
##  0.135  0.147  0.124  0.137  0.117  0.118  0.119  0.141  0.143  0.130  0.127 
##    102    103    104    105    106    107    108    109    110    111    112 
##  0.147  0.147  0.136  0.147  0.167  0.169  0.157  0.163  0.185  0.195  0.177 
##    113    114    115    116    117    118    119    120    121    122    123 
##  0.178  0.176  0.187  0.182  0.205  0.185  0.170  0.176  0.169  0.174  0.172 
##    124    125    126    127    128    129    130    131    132    133    134 
##  0.186  0.179  0.158  0.141  0.149  0.144  0.159  0.137  0.122  0.123  0.120 
##    135    136    137    138    139    140    141    142    143    144    145 
##  0.128  0.120  0.117  0.108  0.112  0.108  0.113  0.097  0.094  0.085  0.073 
##    146    147    148    149    150    151    152    153    154    155    156 
##  0.087  0.096  0.099  0.084  0.075  0.070  0.057  0.064  0.065  0.055  0.063 
##    157    158    159    160    161    162    163    164    165    166    167 
##  0.061  0.059  0.056  0.052  0.050  0.042  0.042  0.035  0.034  0.039  0.039 
##    168    169    170    171    172    173    174    175    176    177    178 
##  0.037  0.038  0.037  0.042  0.032  0.044  0.032  0.051  0.033  0.030  0.024 
##    179    180    181    182    183    184    185    186    187    188    189 
##  0.022  0.037  0.023  0.019  0.034  0.023  0.018  0.014  0.007  0.000  0.007 
##    190    191    192    193    194    195    196    197    198    199    200 
##  0.007  0.006 -0.006 -0.008 -0.007 -0.007 -0.011 -0.027 -0.038 -0.032 -0.041 
##    201    202    203    204    205    206    207    208    209    210    211 
## -0.041 -0.045 -0.035 -0.038 -0.047 -0.054 -0.060 -0.054 -0.066 -0.061 -0.048 
##    212    213    214    215    216    217    218    219    220    221    222 
## -0.039 -0.044 -0.040 -0.027 -0.052 -0.045 -0.057 -0.036 -0.039 -0.031 -0.055 
##    223    224    225    226    227    228    229    230    231    232    233 
## -0.057 -0.052 -0.050 -0.052 -0.062 -0.060 -0.062 -0.067 -0.074 -0.063 -0.061 
##    234    235    236    237    238    239    240    241    242    243    244 
## -0.066 -0.079 -0.075 -0.077 -0.082 -0.092 -0.099 -0.089 -0.083 -0.106 -0.107 
##    245    246    247    248    249    250 
## -0.100 -0.101 -0.112 -0.112 -0.109 -0.110</code></pre>
<pre class="r"><code># Visualize lag

ccf_df |&gt; 
  ggplot() +
  geom_point(aes(x = date_lag, y = scaled_o3), color = &quot;#440154&quot;) +
  geom_point(aes(x = date, y = ili_pne_visits), color = &quot;#D8B26A&quot;) +
  labs(title = &quot;Lagging Ozone variable by 117 days&quot;, 
       x = &quot;Date&quot;,
       y = &quot;Scaled O3&quot;) +
  geom_vline(xintercept = as.numeric(as.Date(c(&quot;2021-01-01&quot;, &quot;2022-01-01&quot;, &quot;2023-01-01&quot;))), color = &quot;grey&quot;)</code></pre>
<p><img src="data_processing_files/figure-html/unnamed-chunk-8-2.png" width="672" /></p>
<pre class="r"><code>prelag_model = lm(ili_pne_visits ~ scaled_o3, data = ccf_df)
summary(prelag_model)</code></pre>
<pre><code>## 
## Call:
## lm(formula = ili_pne_visits ~ scaled_o3, data = ccf_df)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -5.5475 -2.5946 -0.9882  1.5118 26.7952 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)   5.8074     0.2011  28.877   &lt;2e-16 ***
## scaled_o3    -0.4331     0.0518  -8.362   &lt;2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 3.953 on 3649 degrees of freedom
## Multiple R-squared:  0.0188, Adjusted R-squared:  0.01853 
## F-statistic: 69.92 on 1 and 3649 DF,  p-value: &lt; 2.2e-16</code></pre>
<pre class="r"><code>ggplot(aes(x = scaled_o3, 
           y = ili_pne_visits),
       data = ccf_df) + 
  geom_point(color = &quot;#FFA500&quot;) +
  geom_smooth(method = &quot;lm&quot;, color = &quot;blue&quot;) +
  labs(title = &quot;Pre-lag: Pneumonia hospital visits vs. Ozone (scaled)&quot;,
       x = &quot;Scaled ozone&quot;, 
       y = &quot;Pneumonia hospital visits&quot;)</code></pre>
<p><img src="data_processing_files/figure-html/unnamed-chunk-8-3.png" width="672" /></p>
<pre class="r"><code>lag_model = lm(ili_pne_visits ~ lagged_o3, data = ccf_df)
summary(lag_model)</code></pre>
<pre><code>## 
## Call:
## lm(formula = ili_pne_visits ~ lagged_o3, data = ccf_df)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -5.7857 -2.5217 -0.8897  1.6270 26.9616 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)  2.73729    0.19172  14.278   &lt;2e-16 ***
## lagged_o3    0.37175    0.04931   7.539    6e-14 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 3.711 on 3532 degrees of freedom
##   (117 observations deleted due to missingness)
## Multiple R-squared:  0.01584,    Adjusted R-squared:  0.01556 
## F-statistic: 56.83 on 1 and 3532 DF,  p-value: 5.998e-14</code></pre>
<pre class="r"><code>ggplot(aes(x = lagged_o3, y = ili_pne_visits), data = ccf_df) + 
  geom_point() +
  geom_smooth(method = &quot;lm&quot;)</code></pre>
<p><img src="data_processing_files/figure-html/unnamed-chunk-8-4.png" width="672" /></p>
<ul>
<li>talk about lag? observe seasonal changes</li>
</ul>
<pre class="r"><code># EDA

## Histograms
ggplot(aes(x = date), data = air_qual_dis) +
  geom_point(aes(y = co_ppm, color = &quot;CO&quot;), size = 1) +
  geom_point(aes(y = o3_ppm, color = &quot;O3&quot;), size = 1) +
  labs(x = &quot;Date&quot;, y = &quot;Pollutant Level&quot;, color = &quot;Pollutant&quot;) +
  scale_color_manual(values = c(&quot;PM2.5&quot; = &quot;blue&quot;, &quot;CO&quot; = &quot;green&quot;, &quot;O3&quot; = &quot;red&quot;, &quot;NO2&quot; = &quot;purple&quot;)) +
  theme_minimal()

ggplot(aes(x = date), data = air_qual_dis) +
  #geom_point(aes(y = pm25_ug_m3_lc, color = &quot;PM2.5&quot;), size = 1) +
  #geom_point(aes(y = co_ppm, color = &quot;CO&quot;), size = 1) +
  geom_point(aes(y = o3_ppm, color = &quot;O3&quot;), size = 1) +
  #geom_point(aes(y = no2_ppb, color = &quot;NO2&quot;), size = 1) +
  labs(x = &quot;Date&quot;, y = &quot;Pollutant Level&quot;, color = &quot;Pollutant&quot;) +
  scale_color_manual(values = c(&quot;PM2.5&quot; = &quot;blue&quot;, &quot;CO&quot; = &quot;green&quot;, &quot;O3&quot; = &quot;red&quot;, &quot;NO2&quot; = &quot;purple&quot;)) +
  theme_minimal()


ggplot(aes(x = pm25_ug_m3_lc), data = air_qual_dis) + geom_histogram() 
ggplot(aes(x = co_ppm), data = air_qual_dis) + geom_histogram() 
ggplot(aes(x = o3_ppm), data = air_qual_dis) + geom_histogram() 
ggplot(aes(x = no2_ppb), data = air_qual_dis) + geom_histogram() 
ggplot(aes(x = sqrt(total_ed_visits)), data = air_qual_dis) + geom_histogram() 

ggplot(aes(x = ili_pne_visits), data = air_qual_dis) + geom_histogram() 
ggplot(aes(x = ili_pne_admissions), data = air_qual_dis) + geom_histogram() 

MASS::boxcox(lm(total_ed_visits ~ 1, data = air_qual_dis))



model1 = lm(count_resp ~ pm25_ug_m3_lc+co_ppm+o3_ppm+no2_ppb, data = air_qual_dis_aqi)
summary(model1)
model2 = lm(count_asth ~ pm25_ug_m3_lc+co_ppm+o3_ppm+no2_ppb, data = air_qual_dis_aqi)
summary(model2)
model3 = lm(total_ed_visits ~ pm25_ug_m3_lc+co_ppm+o3_ppm+no2_ppb, data = air_qual_dis_aqi)
summary(model3)
model4 = lm(ili_pne_visits ~ pm25_ug_m3_lc+co_ppm+o3_ppm+no2_ppb, data = air_qual_dis_aqi)
summary(model4)
model5 = lm(ili_pne_admissions ~ pm25_ug_m3_lc+co_ppm+o3_ppm+no2_ppb, data = air_qual_dis_aqi)
summary(model5)
base_model = lm(total_ed_visits ~ pm25_ug_m3_lc, data = air_qual_dis_aqi)

model = base_model |&gt; MASS::stepAIC(direction = &quot;both&quot;, trace = 0)
summary(model)

model1 |&gt; ggplot(aes(x = pm25_ug_m3_lc, y = total_ed_visits)) + geom_point()</code></pre>
<pre class="r"><code># Old code
library(tidyverse)

# Load dataset with respiratory and asthma counts
dis_df = read_csv(&quot;data/cleaned_data/joined_respiratory.csv&quot;) |&gt; 
  filter(zip != 88888 &amp; zip != &quot;Citwide&quot; &amp; age_group == &quot;All age groups&quot;) |&gt; 
  mutate(date = as.Date(format(as.Date(date, &quot;%m/%d/%y&quot;))),
         year = as.numeric(format(date, format = &quot;%Y&quot;)),
         month = month.name[as.numeric(format(date, format = &quot;%m&quot;))],
         day = as.numeric(format(date, format = &quot;%d&quot;)),
         zip = as.numeric(zip)) |&gt;
  select(-date, -age_group)

# Load cleaned air quality dataset that has been merged with disease
air_dis_df = read_csv(&quot;data/cleaned_data/air_quality_disease.csv&quot;) |&gt; 
  rename(zip = zip_code) |&gt; 
  mutate(day = as.numeric(day)) |&gt; 
  select(year, month, day, zip, total_ed_visits, ili_pne_visits, ili_pne_admissions, everything())

# Merge two datasets
all_dis_df =
  full_join(dis_df, air_dis_df, by = c(&quot;month&quot;, &quot;day&quot;, &quot;year&quot;, &quot;zip&quot;)) |&gt; 
  select(year, month, day, zip, total_ed_visits, ili_pne_visits, ili_pne_admissions, count_resp, count_asth, everything())

# Realized many NAs, suspect zipcode and date NAs
checkdate_perzip_airdis = airqual_annual |&gt; 
  group_by(geo_place_name) |&gt; 
  summarize(count = n())

checkdate_perzip_dis = dis_df |&gt; 
  group_by(zip) |&gt; 
  summarize(count = n())

# Found many NAs in air_quality_disease.csv - need revision

# Load cleaned air quality dataset that has been merged with disease
air_dis_df = read_csv(&quot;data/cleaned_data/air_quality_disease.csv&quot;) |&gt; 
  rename(zip = zip_code) |&gt; 
  mutate(day = as.numeric(day)) |&gt; 
  select(year, month, day, zip, total_ed_visits, ili_pne_visits, ili_pne_admissions, everything())

# Realized many NAs, suspect zipcode and date NAs
checkdate_perzip_airdis = air_dis_df |&gt; 
  group_by(zip) |&gt; 
  summarize(count = n())

checkdate_perzip_dis = dis_df |&gt; 
  group_by(zip) |&gt; 
  summarize(count = n())

# Found many NAs in air_quality_disease.csv - need revision</code></pre>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->
<script>
$(document).ready(function () {
  window.initializeCodeFolding("hide" === "show");
});
</script>

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
