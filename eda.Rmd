---
title: "Exploratory Analysis and Visualizations"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---

```{r, echo = FALSE, message = FALSE}
library(tidyverse)
library(leaflet)
library(plotly)
options(readr.show_col_types = FALSE)
```

# Air quality EDA

The Air Quality data is split into seasonal and yearly data, which gives us an idea of pollution in all of New York City's neighborhoods, and daily data, which is more precise with regards to time and location where the measurement was done, but is not available for all neighborhoods in New York City.

## Seasonal and Yearly Data

From the histogram and the boxplots below, it appears that PM2.5 concentrations have been steadily decreasing since 2010. The same trend is evident for NO2, but the decrease seems to be much more gradual relative to PM2.5. Finally, Ozone does not appear to be increasing or decreasing over the time period

```{r, message = FALSE, echo = FALSE}
df_histo_pm2.5 = 
  read_csv("data/cleaned_data/uhf_airquality.csv") |> 
  filter(str_detect(time_period, "Annual Average")) |> 
  mutate(year = str_extract(time_period, "\\d{4}")) |> 
  filter(name == "Fine particles (PM 2.5)",
         year != 2009) |> 
  select(year, data_value)

df_histo_NO2 = 
  read_csv("data/cleaned_data/uhf_airquality.csv")  |> 
  filter(str_detect(time_period, "Annual Average")) |> 
  mutate(year = str_extract(time_period, "\\d{4}")) |> 
  filter(name == "Nitrogen dioxide (NO2)",
         year != 2009) |> 
  select(year, data_value) 

df_histo_ozone =
  read_csv("data/cleaned_data/uhf_airquality.csv")  |> 
  filter(name == "Ozone (O3)") |> 
  mutate(year = str_extract(time_period, "\\d{4}")) |> 
  select(year, data_value) |> 
  filter(year != 2009)
```


### Histogram of levels of air pollutants by year

```{r}
all_years = sort(unique(c(as.numeric(df_histo_pm2.5$year),
                           as.numeric(df_histo_NO2$year),
                           as.numeric(df_histo_ozone$year))))

combined_fig = plot_ly()


pollutants_data = list(df_histo_pm2.5, df_histo_NO2, df_histo_ozone)
pollutant_names = c("PM2.5", "NO2", "O3")
pollutant_units = c("PM2.5 Concentration (mcg/m3)", "NO2 Concentration (ppb)", "O3 Concentration (ppb)")


for(i in seq_along(pollutants_data)) {

  for(year_value in all_years) {
    year_data = filter(pollutants_data[[i]], year == as.character(year_value))
    combined_fig = combined_fig |>
      add_histogram(data = year_data, 
                    x = ~data_value, 
                    name = as.character(year_value),
                    marker = list(opacity = 0.6),
                    visible = i == 1) 
  }
}

num_years = length(all_years)
buttons = lapply(seq_along(pollutants_data), function(i) {
  visibility = c(rep(FALSE, num_years * (i - 1)), 
                 rep(TRUE, num_years), 
                 rep(FALSE, num_years * (length(pollutants_data) - i)))
  list(method = "update",
       args = list(list("visible" = visibility),
                   list("title" = paste(pollutant_names[i], "Concentration"),
                        "xaxis.title" = pollutant_units[i])),
       label = pollutant_names[i])
})

combined_fig = combined_fig |>
  layout(title = "Comparison of Pollutant Concentrations",
         barmode = "overlay",
         xaxis = list(title = "Concentration"),
         yaxis = list(title = 'Count of Measurements'),
         updatemenus = list(list(type = "dropdown", buttons = buttons)))

combined_fig
```

### Boxplots of levels of air pollutants by year 

```{r}
add_yearly_boxplots = function(data, years, name_prefix, visible) {
  for(year_value in years) {
    year_data = filter(data, year == as.character(year_value))
    combined_boxplot_fig <<- combined_boxplot_fig |>
      add_trace(data = year_data, 
                y = ~data_value, 
                type = 'box',
                name = paste(name_prefix, year_value),
                visible = visible)
  }
}


combined_boxplot_fig = plot_ly()


add_yearly_boxplots(df_histo_pm2.5, all_years, "PM2.5", TRUE)

add_yearly_boxplots(df_histo_NO2, all_years, "NO2", FALSE)
add_yearly_boxplots(df_histo_ozone, all_years, "O3", FALSE)


buttons = lapply(seq_along(pollutants_data), function(i) {
  visibility = c(rep(i == 1, num_years), rep(i == 2, num_years), rep(i == 3, num_years))
  list(
    method = "update",
    args = list(
      list("visible" = visibility),
      list(
        "title" = paste(pollutant_names[i], "Concentration"),
        "yaxis.title" = pollutant_units[i]
      )
    ),
    label = pollutant_names[i]
  )
})


combined_boxplot_fig = combined_boxplot_fig |>
  layout(
    title = "Comparison of Pollutant Concentrations (Boxplots)",
    yaxis = list(title = pollutant_units[1]), 
    updatemenus = list(list(type = "dropdown", buttons = buttons))
  )

combined_boxplot_fig

```

## Daily Data

```{r message = FALSE, echo = FALSE}
daily_air = read_csv(here::here("data/cleaned_data/alt_air_data.csv")) %>%
  mutate(borough = case_when(
    county == "New York" ~ "Manhattan",
    county == "Bronx" ~ "Bronx",
    county == "Kings" ~ "Brooklyn",
    county == "Queens" ~ "Queens",
    county == "Richmond" ~ "Staten Island"
     ),
    pollutant= case_when(
    pollutant == "PM2.5" ~ "PM 2.5",
    pollutant == "Ozone" ~ "O3",
    T ~ pollutant )) %>% 
  filter(pollutant != "CO") %>%
  mutate(
    pollutant = str_c(pollutant, " (", units, ")")
  )
  
```

### Distributions of pollutant measurements by borough

```{r}
daily_air %>%
  ggplot() + geom_boxplot(aes(x = borough, y = value, fill = borough)) + 
  labs(x = "Borough", y = "Measurement value", fill = "Borough") +
  theme(axis.text.x  = element_text(angle=15)) +
  facet_wrap(~pollutant, scales = 'free')
```

### Time series plots for select neighborhoods

```{r}
#this data maps measurement sites to neighborhoods

sites_nghbors = read_csv(here::here("data/cleaned_data/pollutant_per_neighborhood.csv"))
```

```{r message = FALSE, echo = FALSE}
#Where Fresh Meadows is Queens and Willowbrook is in Staten Island
#Hunts Point - Mott Haven is in Bronx

#my neighborhoods on interest:

neighborhoods = c("Washington Heights", "Union Square - Lower East Side",
                  "Willowbrook", "Hunts Point - Mott Haven", "Fresh Meadows")

store_data = vector("list", length = 5)

for (i in 1:length(neighborhoods)) {
  
  n = neighborhoods[i]
  
  n_zips = sites_nghbors %>%
  filter(geo_place_name == n) %>%
  pull(zip_code)
  
  daily_data = daily_air %>%
    filter(zip_code %in% n_zips) %>%
    group_by(date, pollutant) %>%
    summarize(mean_value = mean(value),
              mean_scaled = mean(scaled_value)) %>%
    mutate(neighborhood = n)
  
  store_data[[i]] = daily_data
  
}
```

```{r}
daily_neighborhood_data = bind_rows(store_data[[1]], store_data[[2]]) %>%
  bind_rows(store_data[[3]]) %>%
  bind_rows(store_data[[4]]) %>%
  bind_rows(store_data[[5]]) %>%
  mutate(date = as.Date(date, format = "%m/%d/%Y"))
```

```{r}
daily_neighborhood_data %>%
  filter(pollutant == "NO2") %>%
  ggplot() + geom_line(aes(x = date, y = mean_value,
                            group = neighborhood, color = neighborhood))
```

```{r}
daily_neighborhood_data %>%
  filter(pollutant == "") %>%
  ggplot() + geom_line(aes(x = date, y = mean_value,
                            group = neighborhood, color = neighborhood))
```

```{r}
daily_neighborhood_data %>%
  filter(pollutant == "PM2.5") %>%
  ggplot() + geom_line(aes(x = date, y = mean_value,
                            group = neighborhood, color = neighborhood))
```


# Disease EDA

## Boxplots of respiratory related hospitalizations
