---
title: "Exploratory Data Analysis and Visualizations"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---

```{r, echo = FALSE, message = FALSE}
library(tidyverse)
library(leaflet)
library(plotly)
options(readr.show_col_types = FALSE)
```

# **Air Pollutants**

The Air Quality data is split into two parts. One consists of seasonal and yearly data, which gives us an idea of pollution in all of New York City's neighborhoods from 2010-2022, while the other involves daily data, which is more precise with regards to time and location where the measurement was done, but is not available for all neighborhoods in New York City and only spans from 2021-2022.

## **Seasonal and Yearly Data**

From the histogram and the boxplots below, it appears that PM2.5 concentrations have been steadily decreasing since 2010. The same trend is evident for NO2, but the decrease seems to be much more gradual relative to PM2.5. Finally, Ozone does not appear to be increasing or decreasing over the time period, but further analysis is needed to confirm this.

```{r, message = FALSE, echo = FALSE}

# Load datasets for interactive histogram and boxplot

df_histo_pm2.5 = 
  read_csv("data/cleaned_data/uhf_airquality.csv") |> 
  filter(str_detect(time_period, "Annual Average")) |> 
  mutate(year = str_extract(time_period, "\\d{4}")) |> 
  filter(name == "Fine particles (PM 2.5)",
         year != 2009) |> 
  select(year, data_value)

df_histo_NO2 = 
  read_csv("data/cleaned_data/uhf_airquality.csv")  |> 
  filter(str_detect(time_period, "Annual Average")) |> 
  mutate(year = str_extract(time_period, "\\d{4}")) |> 
  filter(name == "Nitrogen dioxide (NO2)",
         year != 2009) |> 
  select(year, data_value) 

df_histo_ozone =
  read_csv("data/cleaned_data/uhf_airquality.csv")  |> 
  filter(name == "Ozone (O3)") |> 
  mutate(year = str_extract(time_period, "\\d{4}")) |> 
  select(year, data_value) |> 
  filter(year != 2009)
```

### Histogram of levels of NO2, O3 and PM2.5 by year

```{r}
all_years = sort(unique(c(as.numeric(df_histo_pm2.5$year),
                           as.numeric(df_histo_NO2$year),
                           as.numeric(df_histo_ozone$year))))

combined_fig = plot_ly()


pollutants_data = list(df_histo_pm2.5, df_histo_NO2, df_histo_ozone)
pollutant_names = c("PM2.5", "NO2", "O3")
pollutant_units = c("PM2.5 Concentration (mcg/m3)", "NO2 Concentration (ppb)", "O3 Concentration (ppb)")


for(i in seq_along(pollutants_data)) {

  for(year_value in all_years) {
    year_data = filter(pollutants_data[[i]], year == as.character(year_value))
    combined_fig = combined_fig |>
      add_histogram(data = year_data, 
                    x = ~data_value, 
                    name = as.character(year_value),
                    marker = list(opacity = 0.6),
                    visible = i == 1) 
  }
}

num_years = length(all_years)
buttons = lapply(seq_along(pollutants_data), function(i) {
  visibility = c(rep(FALSE, num_years * (i - 1)), 
                 rep(TRUE, num_years), 
                 rep(FALSE, num_years * (length(pollutants_data) - i)))
  list(method = "update",
       args = list(list("visible" = visibility),
                   list("title" = paste(pollutant_names[i], "Concentration"),
                        "xaxis.title" = pollutant_units[i])),
       label = pollutant_names[i])
})

combined_fig = combined_fig |>
  layout(title = "Comparison of Pollutant Concentrations",
         barmode = "overlay",
         xaxis = list(title = "Concentration"),
         yaxis = list(title = 'Count of Measurements'),
         updatemenus = list(list(type = "dropdown", buttons = buttons)))

combined_fig
```

### Boxplots of levels of NO2, O3 and PM2.5 by year 

```{r}
add_yearly_boxplots = function(data, years, name_prefix, visible) {
  for(year_value in years) {
    year_data = filter(data, year == as.character(year_value))
    combined_boxplot_fig <<- combined_boxplot_fig |>
      add_trace(data = year_data, 
                y = ~data_value, 
                type = 'box',
                name = paste(name_prefix, year_value),
                visible = visible)
  }
}


combined_boxplot_fig = plot_ly()


add_yearly_boxplots(df_histo_pm2.5, all_years, "PM2.5", TRUE)

add_yearly_boxplots(df_histo_NO2, all_years, "NO2", FALSE)
add_yearly_boxplots(df_histo_ozone, all_years, "O3", FALSE)


buttons = lapply(seq_along(pollutants_data), function(i) {
  visibility = c(rep(i == 1, num_years), rep(i == 2, num_years), rep(i == 3, num_years))
  list(
    method = "update",
    args = list(
      list("visible" = visibility),
      list(
        "title" = paste(pollutant_names[i], "Concentration"),
        "yaxis.title" = pollutant_units[i]
      )
    ),
    label = pollutant_names[i]
  )
})


combined_boxplot_fig = combined_boxplot_fig |>
  layout(
    title = "Comparison of Pollutant Concentrations (Boxplots)",
    yaxis = list(title = pollutant_units[1]), 
    updatemenus = list(list(type = "dropdown", buttons = buttons))
  )

combined_boxplot_fig

```

## **Daily Data**

Now that we have looked at how pollution levels change over the years, let's examine the pollution variables at a more granular level. In this data, we have 18,452 rows, where each row is a date-measurement site-pollutant combination.

### How do pollutant variables change over time?

After restricting our analysis to roughly 2020 to 2022, we generate visualizations of the distributions of certain pollutants of interest. Throughout the year, we see oscillations in the levels of Ozone (O3) and Nitrogen Dioxide (NO2) throughout the year, with the former reaching its highest levels in the summer months and the latter peaking in the winter. Carbon Monoxide (CO) also exhibits oscillations, but to a much lower degree. PM2.5, a type of fine particulate matter with 2.5 microns or less in diameter, does not appear to exhibit a seasonal pattern. 

This makes sense intuitively, as we would expect higher emissions from heating and transportation to gather in urban regions due to colder temperatures, leading to higher levels of Nitrogen Dioxide and Carbon Monoxide. In fact, [epidemics of CO poisoning](https://pubmed.ncbi.nlm.nih.gov/9950394/) commonly occurs during winter months and sources include smoke from fires, fumes from heating systems burning fuels, and exhaust fumes from motor vehicles. On the other hand, according to the [American Lung Association](https://www.lung.org/clean-air/outdoors/what-makes-air-unhealthy/ozone#), high levels of Ozone are more likely to form in warmer temperatures, which is why harmful ozone levels primarily occur in the summer in most of the US because climate change is driving warmer temperatures.

```{r, out.width = '100%', message = F}
air_qual_df = read_csv("data/cleaned_data/alt_air_data.csv") |> 
  separate(date, into=c("month", "day", "year")) |>
  mutate(day = as.numeric(day),
         month = month.name[as.numeric(month)],
         year = as.numeric(year)) |> 
  filter(!(year == '2020' & month == 'January'),
         !(year == '2020' & month == 'February')) |> 
  rename(zip = zip_code) |> 
  select(year, month, day, zip, pollutant, value) |> 
  group_by(day, month, year, zip, pollutant) |> 
  summarize(value = mean(value))

poll_plot = air_qual_df |> 
  mutate(
    numeric_month = match(month, month.name),
    date = as.Date(paste(year, numeric_month, day, sep = "-"), 
                   format = "%Y-%m-%d"),
    pollutant = case_when(
      pollutant =="CO" ~ "Carbon Monoxide (ppm)",
      pollutant =="PM2.5" ~ "PM2.5 (μg/m3)",
      pollutant =="Ozone" ~ "Ozone (ppm)",
      pollutant =="NO2" ~ "Nitrogen Dioxide (ppb)"),
    across(pollutant, ~factor(., levels=c("Carbon Monoxide (ppm)",
                                          "Ozone (ppm)",
                                          "Nitrogen Dioxide (ppb)",
                                          "PM2.5 (μg/m3)"))),) |> 
  ggplot(aes(x = date, y = value, color = pollutant)) +
  geom_point() +
  geom_smooth(color = "blue") +
  facet_wrap(~ pollutant, ncol = 2, scales="free_y") +
  ggtitle("Daily average of each pollutant by zip code") + 
  scale_color_discrete()

poll_plot
```

```{r message = FALSE, echo = FALSE}
daily_air = read_csv(here::here("data/cleaned_data/alt_air_data.csv")) %>%
  mutate(borough = case_when(
    county == "New York" ~ "Manhattan",
    county == "Bronx" ~ "Bronx",
    county == "Kings" ~ "Brooklyn",
    county == "Queens" ~ "Queens",
    county == "Richmond" ~ "Staten Island"
     ),
    pollutant= case_when(
    pollutant == "PM2.5" ~ "PM 2.5",
    pollutant == "Ozone" ~ "O3",
    T ~ pollutant )) %>% 
  filter(pollutant != "CO") %>%
  mutate(
    pollutant = str_c(pollutant, " (", units, ")")
  )
  
```

### Distributions of NO2, O3 and PM2.5 by borough

Now that we have seen how these pollutant variables change over time, we want to know whether they differ by borough. We see that at the borough-level, the daily measurements are similar for all pollutants. 

```{r}
daily_air %>%
  ggplot() + geom_boxplot(aes(x = borough, y = value, fill = borough)) + 
  labs(x = "Borough", y = "Measurement value", fill = "Borough") +
  theme(axis.text.x  = element_text(angle=15)) +
  facet_wrap(~pollutant, scales = 'free')
```

### Time series plots for select neighborhoods

In these time series plots, each line represents the mean measurement per day for measurements taken in that neighborhood. The neighborhoods follow similar trends: NO2 seems to peak sometime between winter and spring, while O3 peaks in the summers and PM 2.5 peaks in the winter.

```{r}
#this data maps measurement sites to neighborhoods

sites_nghbors = read_csv(here::here("data/cleaned_data/pollutant_per_neighborhood.csv"))
```

```{r message = FALSE, echo = FALSE}
#Where Fresh Meadows is Queens and Willowbrook is in Staten Island
#Hunts Point - Mott Haven is in Bronx

#my neighborhoods on interest:

neighborhoods = c("Washington Heights", "Union Square - Lower East Side",
                  "Willowbrook", "Hunts Point - Mott Haven", "Fresh Meadows")

store_data = vector("list", length = 5)

for (i in 1:length(neighborhoods)) {
  
  n = neighborhoods[i]
  
  n_zips = sites_nghbors %>%
  filter(geo_place_name == n) %>%
  pull(zip_code)
  
  daily_data = daily_air %>%
    filter(zip_code %in% n_zips) %>%
    group_by(date, pollutant) %>%
    summarize(mean_value = mean(value),
              mean_scaled = mean(scaled_value)) %>%
    mutate(neighborhood = n)
  
  store_data[[i]] = daily_data
  
}
```

```{r}
daily_neighborhood_data = bind_rows(store_data[[1]], store_data[[2]]) %>%
  bind_rows(store_data[[3]]) %>%
  bind_rows(store_data[[4]]) %>%
  bind_rows(store_data[[5]]) %>%
  mutate(date = as.Date(date, format = "%m/%d/%Y"))
```

```{r}
daily_neighborhood_data %>%
  filter(pollutant == "NO2 (ppb)") %>%
  ggplot() + geom_line(aes(x = date, y = mean_value,
                            group = neighborhood, color = neighborhood)) +
  scale_color_manual(values = c("red", "blue", 
                                    "green","orange", 
                                    "black")) +
  labs(title = "NO2 measurements per neighborhood", x = "Date", 
       y = "Mean measurement (ppb)", color = "Neighborhood")
```


```{r}
daily_neighborhood_data %>%
  filter(pollutant == "O3 (ppm)") %>%
  ggplot() + geom_line(aes(x = date, y = mean_value,
                            group = neighborhood, color = neighborhood)) +
  scale_color_manual(values = c("red", "blue", 
                                    "green","orange", 
                                    "black")) +
  labs(title = "O3 measurements per neighborhood", x = "Date", 
       y = "Mean measurement (ppm)", color = "Neighborhood")
```

```{r}
daily_neighborhood_data %>%
  filter(pollutant == "PM 2.5 (ug/m3 LC)") %>%
  ggplot() + geom_line(aes(x = date, y = mean_value,
                            group = neighborhood, color = neighborhood)) +
  scale_color_manual(values = c("red", "blue", 
                                    "black",
                                    "green","orange")) +
  labs(title = "PM 2.5 measurements per neighborhood", x = "Date", 
       y = "Mean measurement (ug/m3 LC)", color = "Neighborhood")
```


# **Disease-related variables**

### How do disease variables change over time?

Here, our analysis also spans from roughly 2020 to 2022. From the plot below, we can see that respiratory diseases, pneumonia-related emergency department visits and admissions all peak during winter seasons, which seems to match up with the time-series plots for Carbon Monoxide and Nitrogen Dioxide. However, the trend for Ozone moves in the opposite direction, which prompts our interest in exploring a potential lagged association between Ozone levels and disease occurrences. To investigate this, we have conducted a [cross-correlation analysis](stats.html) as an attempt to uncover any potential associations.


```{r, out.width = '100%', message = F, warning = F}
all_dis_plot_df = read_csv("data/cleaned_data/disease_only.csv") |>
  mutate(
    numeric_month = match(month, month.name),
    date = as.Date(paste(year, numeric_month, day, sep = "-"), format = "%Y-%m-%d")
  ) |> 
  select(-day, -month, -year, -numeric_month, -total_ed_visits) |> 
  pivot_longer(cols = c("count_resp", "count_asth", "ili_pne_visits", "ili_pne_admissions"), 
               names_to = "variable",
               values_to = "count")

dis_plot = all_dis_plot_df |> 
  
  mutate(variable = case_when(
      variable =="count_resp" ~ "Respiratory diseases",
      variable =="count_asth" ~ "Asthma",
      variable =="ili_pne_visits" ~ "Pneumonia (ER visits)",
      variable =="ili_pne_admissions" ~ "Pneumonia (admissions)"),
      across(variable, ~factor(., levels=c("Asthma","Respiratory diseases",
                                           "Pneumonia (ER visits)",
                                           "Pneumonia (admissions)"))))|> 
  ggplot(aes(x = date, y = count, color = variable)) +
  geom_point() +
  geom_smooth(color = "blue") +
  facet_wrap(~ variable, ncol = 2, scales="free_y") +
  ggtitle("Daily counts of disease variables by zip") + 
  scale_color_discrete()

dis_plot
```

### Boxplots of respiratory related hospitalizations
