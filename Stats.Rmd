---
title: "Statistical Analysis"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---
```{r, echo=FALSE, message = FALSE, warning = FALSE}
library(tidyverse)
library(broom)
library(plotly)

options(readr.show_col_types = FALSE)
```

### 

# Investigating the lagged association of Ozone with variables related to respiratory diseases

## Cross correlation analysis

```{r, out.width='100%', results = 'hide'}
ccf_df = read_csv("data/cleaned_data/final_airqualdis.csv") |> 
  filter(!is.na(o3_ppm) & !is.na(ili_pne_visits)) |> 
  mutate(date_lag = date + days(125),
         scaled_o3 = o3_ppm * 100, 
         lagged_pne = lag(ili_pne_visits, n = 125)
  )

ccf_res = ccf(ccf_df$o3_ppm, ccf_df$ili_pne_visits, lag.max=250, plot = FALSE)
plot(ccf_res, main = "Analysing Lag between Ozone and Pneumonia ER visits (in days)")

# Visualize lag

ccf_df |> 
  ggplot() +
  geom_point(aes(x = date_lag, y = lagged_pne, color = "Pneumonia ER visits")) +
  geom_point(aes(x = date, y = scaled_o3, color = "Ozone (10^-2 ppm)")) +
  labs(title = "Lagging Pneumonia ER visits by 125 days", 
       x = "Date",
       y = "Values") +
  scale_color_manual(labels = c("Ozone (10^-2 ppm)", "Pneumonia hospital visits"), 
                     values = c("Ozone (10^-2 ppm)" = "#FFA500", "Pneumonia ER visits" = "#6495ED"), 
                     guide = "legend")

prelag_model = lm(ili_pne_visits ~ scaled_o3, data = ccf_df)
broom::tidy(prelag_model)
ggplot(aes(x = scaled_o3, y = ili_pne_visits), data = ccf_df) + 
  geom_point(color = "#FFA500") +
  geom_smooth(method = "lm", color = "blue") +
  labs(title = "Pre-lag: Pneumonia ER visits vs. Ozone",
       x = expression(paste("Ozone (", 10^-2, " ppm)")), 
       y = "Pneumonia hospital visits (count)")

lag_model = lm(lagged_pne ~ scaled_o3, data = ccf_df)
broom::tidy(lag_model)
ggplot(aes(x = scaled_o3, y = lagged_pne), data = ccf_df) + 
  geom_point(color = "#FFA500") +
  geom_smooth(method = "lm", color = "blue") +
  labs(title = "Post-lag: Pneumonia ER visits vs. Ozone",
       x = expression(paste("Ozone (", 10^-2, " ppm)")), 
       y = "Pneumonia hospital visits (count)")
```














### ALL LINES BELOW THIS WILL BE REMOVED - MOVE TO SECTION ABOVE IF WANT TO REMAIN


## Regression of Fine Particles (PM 2.5) over time (testing the state of new york's claim that air pollutants are decreasing)

```{r, eval = FALSE}
plot_data |> 
  filter(name == "Fine particles (PM 2.5)") |> 
  ggplot(aes(x = year, y = mean_dv)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) + 
  labs(title = "PM2.5 Levels Throughout NYC Over Time",
       x = "Date",
       y = "Pollutant Level (mcg/m3)")


filtered_data = plot_data |> 
  filter(name == "Fine particles (PM 2.5)")

model =
  lm(mean_dv ~ year, data = filtered_data)

summary(model)
```

## Asthma related hospitalizations vs. PM2.5 concentration

```{r}
df_air_zips = 
  read_csv("data/cleaned_data/air_quality_zips.csv") |> 
  mutate(zip = as.factor(zip)) |>
  filter(str_detect(time_period, "Annual Average")) |> 
  mutate(year = str_extract(time_period, "\\d{4}")) |> 
  filter(year >= 2016 & year <= 2020)

asthma_nyc = 
  read_csv("data/disease_datasets/asthmanyc_clean.csv") |> 
  janitor::clean_names() |> 
  select(!c(data_note_1, data_note_2, dim1name)) |> 
  filter(dim2value == "All age groups",
         zip != 88888,
         zip != "Citwide") |> 
  mutate(count = as.numeric(count),
         year = date) |> 
  filter(year >= 2016 & year <= 2020)

df_asthma_air = 
  merge(asthma_nyc, df_air_zips, by = c("zip", "year"))

model_asth_pm2.5_data =
  df_asthma_air |> 
  filter(name == "Fine particles (PM 2.5)")

model_asth_pm2.5 =
  lm(count ~ data_value, data = model_asth_pm2.5_data)

summary(model_asth_pm2.5)

model_asth_pm2.5_data |> 
  ggplot(aes(x = data_value, y = count)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE)
```

## Asthma related hospitalizations vs. NO2 concentration

```{r}
model_asth_no2_data =
  df_asthma_air |> 
  filter(name == "Nitrogen dioxide (NO2)")

model_asth_no2 =
  lm(count ~ data_value, data = model_asth_no2_data)

summary(model_asth_no2)

model_asth_no2_data |> 
  ggplot(aes(x = data_value, y = count)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE)
```

## General respiratory hospitalization vs PM2.5

```{r}
respiratory_nyc = 
  read_csv("data/disease_datasets/respiratorynyc_clean.csv") |> 
  janitor::clean_names() |> 
  select(!c(data_note_1, data_note_2, dim1name)) |> 
  filter(dim2value == "All age groups",
         zip != 88888,
         zip != "Citwide") |> 
  mutate(count = as.numeric(count),
         year = date) |> 
  filter(year >= 2016 & year <= 2020)

df_resp_air = 
  merge(respiratory_nyc, df_air_zips, by = c("zip", "year"))

model_resp_pm2.5_data =
  df_resp_air |> 
  filter(name == "Fine particles (PM 2.5)")

model_resp_pm2.5 =
  lm(count ~ data_value, data = model_resp_pm2.5_data)

summary(model_resp_pm2.5)

model_resp_pm2.5_data |> 
  ggplot(aes(x = data_value, y = count)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE)
```

## general respiratory hospitalizations vs. NO2

```{r}
model_resp_NO2_data =
  df_resp_air |> 
  filter(name == "Nitrogen dioxide (NO2)")

model_NO2_resp =
  lm(count ~ data_value, data = model_resp_NO2_data)

summary(model_NO2_resp)

model_resp_NO2_data |> 
  ggplot(aes(x = data_value, y = count)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE)
```

## Ozone and asthma

```{r}
df_ozone =
  read_csv("data/cleaned_data/air_quality_zips.csv") |> 
  filter(name == "Ozone (O3)") |> 
  filter(str_detect(time_period, "2016|2017|2018|2019|2020")) |> 
  mutate(year = str_extract(time_period, "\\d{4}"))

df_asth_ozone = 
  merge(asthma_nyc, df_ozone, by = c("zip", "year"))

model_ozone_asth =
  lm(count ~ data_value, data = df_asth_ozone)

summary(model_ozone_asth)

df_asth_ozone |> 
  ggplot(aes(x = data_value, y = count)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE)
```


## Ozone and respiratory disease (general)

```{r}
df_ozone =
  read_csv("data/cleaned_data/air_quality_zips.csv") |> 
  filter(name == "Ozone (O3)") |> 
  filter(str_detect(time_period, "2016|2017|2018|2019|2020")) |> 
  mutate(year = str_extract(time_period, "\\d{4}"))

df_resp_ozone = 
  merge(respiratory_nyc, df_ozone, by = c("zip", "year"))

model_ozone_resp =
  lm(count ~ data_value, data = df_resp_air)

summary(model_ozone_resp)

df_resp_ozone |> 
  ggplot(aes(x = data_value, y = count)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE)


tidy_model =
  tidy(model_ozone_resp)

print(tidy_model) |> 
  knitr::kable()


```

Readings were taken in Summer.

```{r}
# dataframe containing both air quality and both disease datasets by date and zip code 
df = read_csv("data/cleaned_data/final_airqualdis.csv")
```


```{r}
# linear reg on daily asthma and 03 pollutant 

model = lm(ili_pne_admissions ~ o3_ppm, data = df) 
ggplot(df, aes(x = o3_ppm, y = ili_pne_admissions))+ 
geom_point()+ 
  geom_smooth(method = "lm", 
              se = FALSE, 
              color = "red") + 
  labs(title = "Linear Regression of Pnem", 
       x = "o3_ppm", 
       y = "pnem")
```

```{r}
#plot_ly
# omitted na
 df_no_na = na.omit(df)

model = lm(ili_pne_admissions ~ o3_ppm, data = df_no_na) 

plot_ly(data = df_no_na, x = ~o3_ppm, y = ~ili_pne_admissions, type = "scatter", mode = "markers", name = "Data") |> 
  layout(title = "Scatterplot",
         xaxis = list(title = "O3 Levels"),
         yaxis = list(title = "PNE Admissions"))

```




```{r}
#ADD REGRESSION LINE
# Selecting specific columns for x and y
x = df_no_na |> 
  select(pm25_ug_m3_lc, o3_ppm, no2_ppb)
y = df_no_na |> 
  select(count_resp, count_asth, total_ed_visits, ili_pne_admissions)

# Initial plot
initial_plot = plot_ly(data = df_no_na, x = ~x[[1]], y = ~y[[1]], type = "scatter", mode = "markers")

# Add regression line for the first set of x and y variables
lm_model = lm(y[[1]] ~ x[[1]])
regression_line_data = data.frame(x = x[[1]], y = predict(lm_model), newdata = df_no_na)
regression_line = plot_ly(data = regression_line_data, x = ~x, y = ~regression_line_data, type = "scatter", mode = "lines", name = "Regression Line", line = list(color = "blue"))

# Create a scatterplot with dropdown menus and regression line
plot_ly() |> 
  add_trace(initial_plot) |> 
  add_trace(regression_line) |> 
  layout(
    updatemenus = list(
      list(
        x = 0.8,
        buttons = lapply(names(x), function(variable) {
          list(
            method = "restyle",
            args = list("x", list(x[[variable]])),
            label = variable)})),
      list(
        y = 0.8,
        buttons = lapply(names(y), function(variable) {
          list(
            method = "restyle",
            args = list("y", list(y[[variable]])),
            label = variable)}))))

```

















