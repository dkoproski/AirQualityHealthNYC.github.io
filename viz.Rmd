---
title: "Interactive Maps"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---

# Maps

Visualizations of the geographic distribution of air pollutants will help inform our later analyses by showing which locations/zip codes are impacted the most by air pollution. Three air pollutants are mapped on this page: Ozone (O3), PM2.5 (fine particles) and Nitrogen Dioxide (NO2). Ozone and Nitrogen dioxide are measured in parts per billion (PPB), while PM2.5 is measured in micrograms per meter cubed ($mcg/m^3$). While all years are not examined later, data is mapped for all years for the sake of completeness.

```{r, echo = FALSE, message = FALSE, warning = FALSE}
library(tidyverse)
library(leaflet)
library(plotly)
library(glue)
library(leaflet.extras)

df_air_geo = 
  read_csv("data/cleaned_data/uhf_airquality.csv") |> 
  mutate(lat = intplat10,
         lon = intplon10) |> 
  select(-intplat10, -intplon10)
```

## 2009-2021: Ozone levels (O3)

Based on the heatmap, it appears that ozone levels are generally at their highest in Lower Manhattan, particularly in 2016 and 2019. High O3 levels are also seen in coastal areas such as Breezy Point (11697). This makes sense since ozone forms at ground level when nitrogen oxides (such as NO2) react with sunlight. There does not appear to be any trend in ozone levels between 2009 and 2021 and levels seem to oscillate without any pattern. 

```{r, out.width = '100%', message = FALSE, warning = FALSE}
# Extract ozone data
o3_data = df_air_geo |> 
  filter(str_detect(name, "Ozone") & str_detect(name, "\\(")) |> 
  mutate(start_date = as.Date(start_date, format = "%m/%d/%Y"),
         year = year(start_date),
         name = str_remove(name, "(due to).*")) |> 
  select(geo_place_name, name, measure, measure_info, year, data_value, lat, lon) |> 
  group_by(geo_place_name, name, year, lat, lon) |> 
  summarize(zipmean = mean(data_value)) |> 
  filter(year != 2009)

# Create yearly dataframes
yearly_data_frames <- list()
for (k in 2010:2021) {
  year_data = o3_data |> 
    filter(year == k)
  df_name = paste0("o3_", k)
  assign(df_name, year_data)
  yearly_data_frames[[as.character(k)]] = year_data
}

# Create map

palette <- c("#39FF14", "#FFFF33", "#FF7F00", "#E31A1C", "#9F0000", "#660000")
legend <- c("15-20", "20-25", "25-30", "30-35", "35-40", ">40")

m = leaflet() |> addTiles()

year_i = unique(o3_data$year)
for(year in year_i) {
  
  
  yeardata = o3_data[o3_data$year == year,]
  
  
  label_text <- glue(
    "<b>Neighborhood: </b> {yeardata$geo_place_name}<br/>",
    "<b>Year: </b> {yeardata$year}<br/>",
    "<b>Zip mean: </b> {yeardata$zipmean} ppb<br/>") |> 
    lapply(htmltools::HTML)
  
  
  m = m |>
    addCircleMarkers(data = yeardata, lng = ~lon, lat = ~lat, radius = .5, opacity = 0.8, 
                     color = ~ifelse(between(zipmean, 15, 20), "#39FF14", 
                                     ifelse(between(zipmean, 20.1, 25), "#FFFF33", 
                                            ifelse(between(zipmean, 25.1, 30),"#FF7F00",
                                                   ifelse(between(zipmean, 30.1, 35), "#E31A1C",
                                                          ifelse(between(zipmean, 35.1, 40), "#9F0000", "#660000"))))),
                     label = label_text, group = as.character(year))
}

m = m |> 
  addHeatmap(data = yeardata,lng = ~lon, lat = ~lat, 
             intensity = 2, blur = 5, max = 4, radius = 10, 
             group = "Heatmap Overlay") |> 
  addLegend(labels = legend, colors = palette, title = "Ozone levels (parts per billion)") |> 
  addLayersControl(overlayGroups = "Heatmap Overlay",
                   baseGroups = year_i,
                   options = layersControlOptions(collapsed = FALSE)) 

m
```


## 2008-2021: Fine Particles PM2.5

Similar to ozone, some of the highest levels of PM2.5 are seen in Lower Manhattan. Unlike O3, however, PM2.5 concentrations generally look to decrease from 2008-2021. This reflects similar trends seen in previous EDA performed on the data. That being said, there is some year-to-year variability and some clusters of zip codes exhibit high levels as late as 2021.

```{r, out.width = '100%', message = FALSE, warning = FALSE}
# Extract pm2.5 data
pm25_data = df_air_geo |> 
  filter(str_detect(name, "Fine")) |> 
  mutate(start_date = as.Date(start_date, format = "%m/%d/%Y"),
         year = year(start_date),
         name = str_remove(name, "(due to).*")) |> 
  select(geo_place_name, name, measure, measure_info, year, data_value, lat, lon) |> 
  group_by(geo_place_name, name, year, lat, lon) |> 
  summarize(zipmean = mean(data_value)) |> 
  filter(year != 2008 & year != 2009)

# Create yearly dataframes
yearly_data_frames <- list()
for (k in 2010:2021) {
  year_data = pm25_data |> 
    filter(year == k)
  df_name = paste0("pm25_", k)
  assign(df_name, year_data)
  yearly_data_frames[[as.character(k)]] = year_data
}

# Create map

palette <- c("#39FF14", "#FFFF33", "#FF7F00", "#E31A1C", "#9F0000", "#660000")
legend <- c("5-7", "7-9", "9-11", "11-13", "13-15", ">15")

m = leaflet() |> addTiles()

year_i = unique(pm25_data$year)
for(year in year_i) {
  
  
  yeardata = pm25_data[pm25_data$year == year,]
  
  
  label_text <- glue(
    "<b>Neighborhood: </b> {yeardata$geo_place_name}<br/>",
    "<b>Year: </b> {yeardata$year}<br/>",
    "<b>Zip mean: </b> {round(yeardata$zipmean,3)} mcg/m3<br/>") |> 
    lapply(htmltools::HTML)
  
  
  m = m |>
    addCircleMarkers(data = yeardata, lng = ~lon, lat = ~lat, radius = .5, opacity = 0.8, 
                     color = ~ifelse(between(zipmean, 5, 7), "#39FF14", 
                                     ifelse(between(zipmean, 7.1, 9), "#FFFF33", 
                                            ifelse(between(zipmean, 9.1, 11),"#FF7F00",
                                                   ifelse(between(zipmean, 11.1, 13), "#E31A1C",
                                                          ifelse(between(zipmean, 13.1, 15), "#9F0000", "#660000"))))),
                     label = label_text, group = as.character(year))
}

m = m |> 
  addHeatmap(data = yeardata,lng = ~lon, lat = ~lat, 
             intensity = 2, blur = 5, max = 4, radius = 10, 
             group = "Heatmap Overlay") |> 
  addLegend(labels = legend, colors = palette, title = "PM2.5 levels (mcg/m3)") |> 
  addLayersControl(overlayGroups = "Heatmap Overlay",
                   baseGroups = year_i,
                   options = layersControlOptions(collapsed = FALSE)) 

m
```


## 2008-2021: Nitrogen dioxide (NO2)

From the map, NO2 levels seem to be at their highest throughout Manhattan. It appears that levels in Manhattan and all surrounding boroughs decrease between 2008 and 2021. 

```{r, out.width = '100%', message = FALSE, warning = FALSE}
# Extract NO2 data
no2_data = df_air_geo |> 
  filter(str_detect(name, "Nitrogen")) |> 
  mutate(start_date = as.Date(start_date, format = "%m/%d/%Y"),
         year = year(start_date),
         name = str_remove(name, "(due to).*")) |> 
  select(geo_place_name, name, measure, measure_info, year, data_value, lat, lon) |> 
  group_by(geo_place_name, name, year, lat, lon) |> 
  summarize(zipmean = mean(data_value)) |> 
  filter(year != 2008 & year != 2009)

# Create yearly dataframes
yearly_data_frames <- list()
for (k in 2010:2021) {
  year_data = no2_data |> 
    filter(year == k)
  df_name = paste0("no2_", k)
  assign(df_name, year_data)
  yearly_data_frames[[as.character(k)]] = year_data
}

# Create map

palette <- c("#39FF14", "#FFFF33", "#FF7F00", "#E31A1C", "#9F0000", "#660000")
legend <- c("8-15", "15-22", "22-29", "29-36", "36-43", "43-50")

m = leaflet() |> addTiles()

year_i = unique(no2_data$year)
for(year in year_i) {
  
  
  yeardata = no2_data[no2_data$year == year,]
  
  
  label_text <- glue(
    "<b>Neighborhood: </b> {yeardata$geo_place_name}<br/>",
    "<b>Year: </b> {yeardata$year}<br/>",
    "<b>Zip mean: </b> {round(yeardata$zipmean,3)} ppb<br/>") |> 
    lapply(htmltools::HTML)
  
  
  m = m |>
    addCircleMarkers(data = yeardata, lng = ~lon, lat = ~lat, radius = .5, opacity = 0.8, 
                     color = ~ifelse(between(zipmean, 8, 15), "#39FF14", 
                                     ifelse(between(zipmean, 15.1, 22), "#FFFF33", 
                                            ifelse(between(zipmean, 22.1, 29),"#FF7F00",
                                                   ifelse(between(zipmean, 29.1, 36), "#E31A1C",
                                                          ifelse(between(zipmean, 36.1, 43), "#9F0000", "#660000"))))),
                     label = label_text, group = as.character(year))
}

m = m |> 
  addHeatmap(data = yeardata,lng = ~lon, lat = ~lat, 
             intensity = 2, blur = 5, max = 4, radius = 10, 
             group = "Heatmap Overlay") |> 
  addLegend(labels = legend, colors = palette, title = "NO2 levels (parts per billion)") |> 
  addLayersControl(overlayGroups = "Heatmap Overlay",
                   baseGroups = year_i,
                   options = layersControlOptions(collapsed = FALSE)) 

m
```


















